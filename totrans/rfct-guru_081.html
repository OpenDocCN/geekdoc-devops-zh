<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Introduce Assertion</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Introduce Assertion</h1>
<blockquote>原文：<a href="https://refactoringguru.cn/introduce-assertion">https://refactoringguru.cn/introduce-assertion</a></blockquote>
    
    

    <script type="text/javascript">
        // Shorten examples titles for users.
        var h1 = document.getElementsByTagName("H1")[0];
        if (h1.offsetHeight &amp;gt; 160) {
            h1.className += ' smaller';
        }

        // Small beautification for pattern examples.
        var title = h1.innerHTML;
        title = title.replace(/^(Java|C\+\+|C#|PHP|Python|Ruby|Delphi): (.*)$/, '&amp;lt;strong&amp;gt;$1:&amp;lt;/strong&amp;gt; $2');
        h1.innerHTML = title;
    </script>

    
    

    <div class="before-after-container">
        <div class="before">
            <h3>Problem</h3>
            <p>For a portion of code to work correctly, certain conditions or values must be true.</p>

        </div>
        <div class="after">
            <h3>Solution</h3>
            <p>Replace these assumptions with specific assertion checks.</p>

        </div>
    </div>

        <div class="examples">
                    <div class="before-after before-after-container java" data-lang="java">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="java">double getExpenseLimit() {
  // Should have either expense limit or
  // a primary project.
  return (expenseLimit != NULL_EXPENSE) ?
    expenseLimit :
    primaryProject.getMemberExpenseLimit();
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="java">double getExpenseLimit() {
  Assert.isTrue(expenseLimit != NULL_EXPENSE || primaryProject != null);

  return (expenseLimit != NULL_EXPENSE) ?
    expenseLimit:
    primaryProject.getMemberExpenseLimit();
}</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container csharp" data-lang="csharp">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="csharp">double GetExpenseLimit() 
{
  // Should have either expense limit or
  // a primary project.
  return (expenseLimit != NULL_EXPENSE) ?
    expenseLimit :
    primaryProject.GetMemberExpenseLimit();
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="csharp">double GetExpenseLimit() 
{
  Assert.IsTrue(expenseLimit != NULL_EXPENSE || primaryProject != null);

  return (expenseLimit != NULL_EXPENSE) ?
    expenseLimit:
    primaryProject.GetMemberExpenseLimit();
}</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container php" data-lang="php">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="php">function getExpenseLimit() {
  // Should have either expense limit or
  // a primary project.
  return ($this-&gt;expenseLimit !== NULL_EXPENSE) ?
    $this-&gt;expenseLimit:
    $this-&gt;primaryProject-&gt;getMemberExpenseLimit();
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="php">function getExpenseLimit() {
  assert($this-&gt;expenseLimit !== NULL_EXPENSE || isset($this-&gt;primaryProject));

  return ($this-&gt;expenseLimit !== NULL_EXPENSE) ?
    $this-&gt;expenseLimit:
    $this-&gt;primaryProject-&gt;getMemberExpenseLimit();
}</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container python" data-lang="python">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="python">def getExpenseLimit(self):
    # Should have either expense limit or
    # a primary project.
    return self.expenseLimit if self.expenseLimit != NULL_EXPENSE else \
        self.primaryProject.getMemberExpenseLimit()</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="python">def getExpenseLimit(self):
    assert (self.expenseLimit != NULL_EXPENSE) or (self.primaryProject != None)

    return self.expenseLimit if (self.expenseLimit != NULL_EXPENSE) else \
        self.primaryProject.getMemberExpenseLimit()</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container typescript" data-lang="typescript">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="typescript">getExpenseLimit(): number {
  // Should have either expense limit or
  // a primary project.
  return (expenseLimit != NULL_EXPENSE) ?
    expenseLimit:
    primaryProject.getMemberExpenseLimit();
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="typescript">getExpenseLimit(): number {
  // TypeScript and JS doesn't have built-in assertions, so we'll use
  // good-old console.error(). You can always extract this into a
  // designated assertion function.
  if (!(expenseLimit != NULL_EXPENSE ||
       (typeof primaryProject !== 'undefined' &amp;&amp; primaryProject))) {
      console.error("Assertion failed: getExpenseLimit()");
  }

  return (expenseLimit != NULL_EXPENSE) ?
    expenseLimit:
    primaryProject.getMemberExpenseLimit();
}</pre>
                                    </div>
            </div>
            </div>
    
    <h3>Why Refactor</h3>
<p>Say that a portion of code assumes something about, for example, the current condition of an object or value of a parameter or local variable. Usually this assumption will always hold true except in the event of an error.</p>
<p>Make these assumptions obvious by adding corresponding assertions. As with type hinting in method parameters, these assertions can act as live documentation for your code.</p>
<p>As a guideline to see where your code needs assertions, check for comments that describe the conditions under which a particular method will work.</p>
<h3>Benefits</h3>
<ul>
<li>If an assumption isn't true and the code therefore gives the wrong result, it's better to stop execution before this causes fatal consequences and data corruption. This also means that you neglected to write a necessary test when devising ways to perform testing of the program.</li>
</ul>
<h3>Drawbacks</h3>
<ul>
<li>
<p>Sometimes an exception is more appropriate than a simple assertion. You can select the necessary class of the exception and let the remaining code handle it correctly.</p>
</li>
<li>
<p>When is an exception better than a simple assertion? If the exception can be caused by actions of the user or system and you can handle the exception. On the other hand, ordinary unnamed and unhandled exceptions are basically equivalent to simple assertions—you don't handle them and they're caused exclusively as the result of a program bug that never should have occurred.</p>
</li>
</ul>
<h3>How to Refactor</h3>
<p>When you see that a condition is assumed, add an assertion for this condition in order to make sure.</p>
<p>Adding the assertion shouldn't change the program's behavior.</p>
<p>Don't overdo it with use of assertions for <strong>everything</strong> in your code. Check for only the conditions that are necessary for correct functioning of the code. If your code is working normally even when a particular assertion is false, you can safely remove the assertion.</p>


    <div class="prom banner-content banner banner-striped banner-with-image" data-id="Ref: Part of the ebook" data-creative-id="animated-en" data-position="content_bottom">
        <div class="banner-image">
            <a href="/refactoring/course">
                <video id="banner-zzz" loop="" muted="" playsinline="" width="200" height="200">
                    <source src="/images/refactoring/banners/tired-of-reading-banner-1x.mp4?id=7fa8f9682afda143c2a491c6ab1c1e56" type="video/mp4">
                    <source src="/images/refactoring/banners/tired-of-reading-banner.png?id=1721d160ff9c84cbf8912f5d282e2bb4" type="image/png">
                    Your browser does not support HTML video.
                </source></source></video>
            </a>
        </div>
        <script>
            if (/CPU (?:iPhone )?OS [1-9]_/.test(navigator.userAgent)) {
                // Don't autoplay on old iOS, since it doesn not support playsinline.
            }
            else {
                document.getElementById('banner-zzz').play();
            }
        </script>

        <div class="banner-text">
            <h3 class="title">Tired of reading?</h3>
            <p class="big">No wonder, it takes <span class="blue">7 hours</span> to read all of the text we have here.</p>
            <p>Try our interactive course on refactoring. It offers a less tedious approach to learning new stuff.</p>
            <a class="btn btn-secondary" href="/refactoring/course"><i class="fa fa-star" aria-hidden="true"/> Let's see…</a>
        </div>
    </div>


        
</body>
</html>