<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Replace Conditional with Polymorphism</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Replace Conditional with Polymorphism</h1>
<blockquote>原文：<a href="https://refactoringguru.cn/replace-conditional-with-polymorphism">https://refactoringguru.cn/replace-conditional-with-polymorphism</a></blockquote>
    
    

    <script type="text/javascript">
        // Shorten examples titles for users.
        var h1 = document.getElementsByTagName("H1")[0];
        if (h1.offsetHeight &amp;gt; 160) {
            h1.className += ' smaller';
        }

        // Small beautification for pattern examples.
        var title = h1.innerHTML;
        title = title.replace(/^(Java|C\+\+|C#|PHP|Python|Ruby|Delphi): (.*)$/, '&amp;lt;strong&amp;gt;$1:&amp;lt;/strong&amp;gt; $2');
        h1.innerHTML = title;
    </script>

    
    

    <div class="before-after-container">
        <div class="before">
            <h3>Problem</h3>
            <p>You have a conditional that performs various actions depending on object type or properties.</p>

        </div>
        <div class="after">
            <h3>Solution</h3>
            <p>Create subclasses matching the branches of the conditional. In them, create a shared method and move code from the corresponding branch of the conditional to it. Then replace the conditional with the relevant method call. The result is that the proper implementation will be attained via polymorphism depending on the object class.</p>

        </div>
    </div>

        <div class="examples">
                    <div class="before-after before-after-container java" data-lang="java">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="java">class Bird {
  // ...
  double getSpeed() {
    switch (type) {
      case EUROPEAN:
        return getBaseSpeed();
      case AFRICAN:
        return getBaseSpeed() - getLoadFactor() * numberOfCoconuts;
      case NORWEGIAN_BLUE:
        return (isNailed) ? 0 : getBaseSpeed(voltage);
    }
    throw new RuntimeException("Should be unreachable");
  }
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="java">abstract class Bird {
  // ...
  abstract double getSpeed();
}

class European extends Bird {
  double getSpeed() {
    return getBaseSpeed();
  }
}
class African extends Bird {
  double getSpeed() {
    return getBaseSpeed() - getLoadFactor() * numberOfCoconuts;
  }
}
class NorwegianBlue extends Bird {
  double getSpeed() {
    return (isNailed) ? 0 : getBaseSpeed(voltage);
  }
}

// Somewhere in client code
speed = bird.getSpeed();</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container csharp" data-lang="csharp">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="csharp">public class Bird 
{
  // ...
  public double GetSpeed() 
  {
    switch (type) 
    {
      case EUROPEAN:
        return GetBaseSpeed();
      case AFRICAN:
        return GetBaseSpeed() - GetLoadFactor() * numberOfCoconuts;
      case NORWEGIAN_BLUE:
        return isNailed ? 0 : GetBaseSpeed(voltage);
      default:
        throw new Exception("Should be unreachable");
    }
  }
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="csharp">public abstract class Bird 
{
  // ...
  public abstract double GetSpeed();
}

class European: Bird 
{
  public override double GetSpeed() 
  {
    return GetBaseSpeed();
  }
}
class African: Bird 
{
  public override double GetSpeed() 
  {
    return GetBaseSpeed() - GetLoadFactor() * numberOfCoconuts;
  }
}
class NorwegianBlue: Bird
{
  public override double GetSpeed() 
  {
    return isNailed ? 0 : GetBaseSpeed(voltage);
  }
}

// Somewhere in client code
speed = bird.GetSpeed();</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container php" data-lang="php">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="php">class Bird {
  // ...
  public function getSpeed() {
    switch ($this-&gt;type) {
      case EUROPEAN:
        return $this-&gt;getBaseSpeed();
      case AFRICAN:
        return $this-&gt;getBaseSpeed() - $this-&gt;getLoadFactor() * $this-&gt;numberOfCoconuts;
      case NORWEGIAN_BLUE:
        return ($this-&gt;isNailed) ? 0 : $this-&gt;getBaseSpeed($this-&gt;voltage);
    }
    throw new Exception("Should be unreachable");
  }
  // ...
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="php">abstract class Bird {
  // ...
  abstract function getSpeed();
  // ...
}

class European extends Bird {
  public function getSpeed() {
    return $this-&gt;getBaseSpeed();
  }
}
class African extends Bird {
  public function getSpeed() {
    return $this-&gt;getBaseSpeed() - $this-&gt;getLoadFactor() * $this-&gt;numberOfCoconuts;
  }
}
class NorwegianBlue extends Bird {
  public function getSpeed() {
    return ($this-&gt;isNailed) ? 0 : $this-&gt;getBaseSpeed($this-&gt;voltage);
  }
}

// Somewhere in Client code.
$speed = $bird-&gt;getSpeed();</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container python" data-lang="python">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="python">class Bird:
    # ...
    def getSpeed(self):
        if self.type == EUROPEAN:
            return self.getBaseSpeed()
        elif self.type == AFRICAN:
            return self.getBaseSpeed() - self.getLoadFactor() * self.numberOfCoconuts
        elif self.type == NORWEGIAN_BLUE:
            return 0 if self.isNailed else self.getBaseSpeed(self.voltage)
        else:
            raise Exception("Should be unreachable")</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="python">class Bird:
    # ...
    def getSpeed(self):
        pass

class European(Bird):
    def getSpeed(self):
        return self.getBaseSpeed()
    
    
class African(Bird):
    def getSpeed(self):
        return self.getBaseSpeed() - self.getLoadFactor() * self.numberOfCoconuts


class NorwegianBlue(Bird):
    def getSpeed(self):
        return 0 if self.isNailed else self.getBaseSpeed(self.voltage)

# Somewhere in client code
speed = bird.getSpeed()</pre>
                                    </div>
            </div>
                    <div class="before-after before-after-container typescript" data-lang="typescript">
                <div class="before">
                    <div class="ba">Before</div>
                                            <pre class="code" lang="typescript">class Bird {
  // ...
  getSpeed(): number {
    switch (type) {
      case EUROPEAN:
        return getBaseSpeed();
      case AFRICAN:
        return getBaseSpeed() - getLoadFactor() * numberOfCoconuts;
      case NORWEGIAN_BLUE:
        return (isNailed) ? 0 : getBaseSpeed(voltage);
    }
    throw new Error("Should be unreachable");
  }
}</pre>
                                    </div>
                <div class="after">
                    <div class="ba">After</div>
                                            <pre class="code" lang="typescript">abstract class Bird {
  // ...
  abstract getSpeed(): number;
}

class European extends Bird {
  getSpeed(): number {
    return getBaseSpeed();
  }
}
class African extends Bird {
  getSpeed(): number {
    return getBaseSpeed() - getLoadFactor() * numberOfCoconuts;
  }
}
class NorwegianBlue extends Bird {
  getSpeed(): number {
    return (isNailed) ? 0 : getBaseSpeed(voltage);
  }
}

// Somewhere in client code
let speed = bird.getSpeed();</pre>
                                    </div>
            </div>
            </div>
    
    <h3>Why Refactor</h3>
<p>This refactoring technique can help if your code contains operators performing various tasks that vary based on:</p>
<ul>
<li>
<p>Class of the object or interface that it implements</p>
</li>
<li>
<p>Value of an object's field</p>
</li>
<li>
<p>Result of calling one of an object's methods</p>
</li>
</ul>
<p>If a new object property or type appears, you will need to search for and add code in all similar conditionals. Thus the benefit of this technique is multiplied if there are multiple conditionals scattered throughout all of an object's methods.</p>
<h3>Benefits</h3>
<ul>
<li>
<p>This technique adheres to the <em>Tell-Don't-Ask</em> principle: instead of asking an object about its state and then performing actions based on this, it's much easier to simply tell the object what it needs to do and let it decide for itself how to do that.</p>
</li>
<li>
<p>Removes duplicate code. You get rid of many almost identical conditionals.</p>
</li>
<li>
<p>If you need to add a new execution variant, all you need to do is add a new subclass without touching the existing code (<em>Open/Closed Principle</em>).</p>
</li>
</ul>
<h3>How to Refactor</h3>
<h4>Preparing to Refactor</h4>
<p>For this refactoring technique, you should have a ready hierarchy of classes that will contain alternative behaviors. If you don't have a hierarchy like this, create one. Other techniques will help to make this happen:</p>
<ul>
<li>
<p><a href="/replace-type-code-with-subclasses">Replace Type Code with Subclasses</a>. Subclasses will be created for all values of a particular object property. This approach is simple but less flexible since you can't create subclasses for the other properties of the object.</p>
</li>
<li>
<p><a href="/replace-type-code-with-state-strategy">Replace Type Code with State/Strategy</a>. A class will be dedicated for a particular object property and subclasses will be created from it for each value of the property. The current class will contain references to the objects of this type and delegate execution to them.</p>
</li>
</ul>
<p>The following steps assume that you have already created the hierarchy.</p>
<h4>Refactoring Steps</h4>
<ol>
<li>
<p>If the conditional is in a method that performs other actions as well, perform <a href="/extract-method">Extract Method</a>.</p>
</li>
<li>
<p>For each hierarchy subclass, redefine the method that contains the conditional and copy the code of the corresponding conditional branch to that location.</p>
</li>
<li>
<p>Delete this branch from the conditional.</p>
</li>
<li>
<p>Repeat replacement until the conditional is empty. Then delete the conditional and declare the method abstract.</p>
</li>
</ol>


    <div class="prom banner-content banner banner-striped banner-with-image" data-id="Ref: Part of the ebook" data-creative-id="animated-en" data-position="content_bottom">
        <div class="banner-image">
            <a href="/refactoring/course">
                <video id="banner-zzz" loop="" muted="" playsinline="" width="200" height="200">
                    <source src="/images/refactoring/banners/tired-of-reading-banner-1x.mp4?id=7fa8f9682afda143c2a491c6ab1c1e56" type="video/mp4">
                    <source src="/images/refactoring/banners/tired-of-reading-banner.png?id=1721d160ff9c84cbf8912f5d282e2bb4" type="image/png">
                    Your browser does not support HTML video.
                </source></source></video>
            </a>
        </div>
        <script>
            if (/CPU (?:iPhone )?OS [1-9]_/.test(navigator.userAgent)) {
                // Don't autoplay on old iOS, since it doesn not support playsinline.
            }
            else {
                document.getElementById('banner-zzz').play();
            }
        </script>

        <div class="banner-text">
            <h3 class="title">Tired of reading?</h3>
            <p class="big">No wonder, it takes <span class="blue">7 hours</span> to read all of the text we have here.</p>
            <p>Try our interactive course on refactoring. It offers a less tedious approach to learning new stuff.</p>
            <a class="btn btn-secondary" href="/refactoring/course"><i class="fa fa-star" aria-hidden="true"/> Let's see…</a>
        </div>
    </div>


        
</body>
</html>