# 禁用未使用的守护程序以加快您的启动顺序

> 原文：<https://acloudguru.com/blog/engineering/disabling-unused-daemons-to-speed-up-your-boot-sequence>

许多 Linux 发行版在启动时通常会启动大量的守护进程，导致开机后需要等待很长时间才能开始工作。大多数用户很少(甚至根本不)使用这些守护进程。本教程描述了如何以适当的方式禁用未使用或很少使用的守护进程，从而加快引导顺序并减少 CPU 负载。注意:尽管本教程旨在对系统友好且不危险，但如果你不知道你在做什么，请不要禁用任何服务。尤其是在服务器系统上，(意外地)禁用一个重要的服务会产生严重的后果。本教程按原样提供，没有任何担保等等。小心点，好吗？=) *另注:本教程使用了“服务”和“守护进程”这两个词。这两个词有着几乎相同的意思，尽管服务更侧重于流程做什么，或者换句话说，流程提供哪种服务。daemon 这个词指的是“物理的”(软件怎么可能是物理的？)过程。*

## 第一部分:如何做

事实上，为了便于阅读，本教程分为两部分。第一部分简单明了地解释了如何禁用这些服务(以及禁用哪些服务)。第二部分(教程部分)解释了它背后的东西，并允许更深入地了解 Linux 引导。如果你不想和/或不需要那种更深入的洞察，就不要读第二部分=)。

## 了解您的系统上正在运行什么

大多数发行版都有某种工具，可以让你管理启动时在电脑上启动的守护进程。最常见的是 chkconfig，它具有命令行界面。您可以使用以下命令列出引导至图形模式时启动的所有进程:

> [re chosen @ localhost ~]$/sbin/chkconfig–list | grep " 5:on "

运行文本模式系统时，通常会引导到运行级别 3。要查看这些系统在引导时启动的进程，请使用以下命令:

> [re chosen @ localhost ~]$/sbin/chkconfig–list | grep " 3:on "

许多发行版还有一个用于守护进程启动配置的 GUI 。一个比较知名的就是 serviceconf。您通常会在“系统”或“配置”中找到这样的 GUI，命名为“服务”、“引导配置”或“守护进程”(注意，第二个 GUI 也可以是引导加载程序的配置 GUI，如 GRUB 或 lilo，这不是我们现在要处理的)。推荐使用 GUI 配置器，因为它们通常比 chkconfig 更适合您的发行版。以下部分包含在某些情况下可以禁用的守护程序列表。将系统上启动的守护程序列表与下面的列表进行比较，阅读说明并确定禁用它是否是个好主意。一旦决定了要禁用哪些服务，继续禁用守护进程。

## 常见的未使用/很少使用的守护进程

以下列表包含“普通”最终用户可能不使用的守护程序。您可以将系统上启动的守护进程列表与此列表进行比较，看看是否可以安全地禁用其中的一些守护进程。

*   **蓝牙**
    *   hcid、sdpd 和 hidd(这些守护进程提供蓝牙服务，如果您没有任何蓝牙硬件，则没有必要)
*   **打印**
    *   cups 和 cups-config-daemon(这些守护进程提供打印机服务，如果您的本地 pc 或网络 pc 上没有连接任何打印机硬件，则不需要这些守护进程)
    *   hpiod 和 hpssd(这些守护程序为 HP 打印机提供了广泛的支持。如果您从未使用惠普打印机打印，可以安全地禁用它们)
*   **控制台**
    *   gpm(这个守护进程为基于文本的应用程序提供鼠标支持，比如 Midnight Commander。它还提供了在控制台环境中使用鼠标中键进行复制/粘贴的功能。如果不经常使用控制台，可以将其禁用)
*   **网络服务器**
    *   httpd(此守护程序提供 web 托管服务，在不托管任何网站或 web 界面的工作站和服务器上是不必要的)
    *   mysqld 和 postgresqld(这些守护进程提供数据库后端服务。如果您没有运行 web 服务器，通常可以禁用它们，尽管有些应用程序使用这些数据库来存储数据)
*   **防火墙**
    *   netfilter/iptables(这个守护进程提供防火墙服务。如果你在内置防火墙的路由器或 smoothwall 后面，这些就没有必要了)
*   **红外线**
    *   irda(这个守护程序使您的计算机能够使用 IR(红外)硬件与其他设备通信。如果您没有这样的硬件，您可以安全地禁用此服务)
    *   这个守护进程使用 IR(红外线)接收器提供远程控制支持。如果您没有能够接收红外信号的硬件，则可以禁用)
*   **多个 CPU**
    *   irqbalance(这个守护进程平衡系统中多个 CPU 的中断。如果您没有多个 CPU 或双核处理器，则可以禁用)
*   **软件 RAID**
    *   mdmonitor、mdadm 和 mdmpd(这些守护程序提供有关软件 RAID 设备的信息和管理功能。如果不使用软件 RAID，它们是不必要的)
*   **DNS 服务器**
    *   命名(也称为 BIND)(此守护程序提供 DNS 服务器功能。工作站上通常不需要)
*   **远程内核日志**
    *   netdump、netcrashdump 和 netconsole(这些服务通过网络连接提供内核日志记录和调试功能。只有当您想在另一台计算机上查看内核的日志和调试消息时才有必要)
*   **文件服务器**
    *   **NFS 服务器**
        *   nfs(这个守护进程提供 NFS 服务器功能，允许其他装有 NFS 客户端的计算机连接到您的计算机并访问文件。如果您不需要/不希望其他人使用 NFS 访问您的系统，您可以禁用此功能)
        *   端口映射(这个守护进程管理 RPC 连接，由 NFS 和 NIS 这样的协议使用。仅在需要充当服务器的计算机上需要)
        *   rpcsvcgssd(这个守护进程管理 NFSv4 服务器的 RPCSEC GSS 上下文，除非您运行的是 NFS 服务器，否则不需要它)
    *   **桑巴服务器**
        *   smbd 和 nmbd(这些守护进程向其他计算机(也包括 Windows 计算机)提供对您的文件的访问。如果您不希望其他人能够通过网络访问您的文件，则不需要这样做)
*   **网络认证**
    *   nscd(这个守护进程处理密码和组查找，并缓存它们的结果。仅在使用“慢速”名称服务时需要，如 NIS、NIS+、LDAP 或 hesiod)
    *   端口映射(这个守护进程管理 RPC 连接，由 NFS 和 NIS 这样的协议使用。仅在需要充当服务器的计算机上需要)
*   **远程时间设置**
    *   ntpd(这个守护进程将您的系统时间设置为它从一个所谓的 ntp 服务器获取的值，这个服务器通常提供非常精确的时间。虽然这是一个有用的特性，但它往往会大大降低系统的启动速度，尤其是在找不到服务器的情况下)
*   **流程核算**
    *   psacct(也称为 acct)(这个守护进程提供进程记帐，可以更详细地了解系统上命令的执行情况。这通常是不需要的，除非你运行的服务器被很多你不能完全信任的人访问)
*   **明文认证请求**
    *   saslauthd(该守护程序处理 SASL 明文身份验证请求，并且仅在需要使用 SASL 机制进行通信的服务器上是必需的)
*   **邮件服务器**
    *   sendmail(这个守护进程作为服务器发送和转发电子邮件。您不需要这个守护进程就可以发送普通消息。只有当您需要计算机充当邮件服务器时才需要它)
    *   spamd(也称为 Spamassassin)(该守护程序检查传入邮件中的垃圾邮件。这通常可以禁用，但请记住，一些邮件客户端，如 KMail，可以使用 spamd 的功能)
*   **SSH 服务器**
    *   sshd(这个守护进程允许使用 SSH 协议远程登录到您的计算机。如果您不想/不需要此访问权限，可以禁用它)
*   **VNC 服务器**
    *   vncserver 或 xvnc(这个守护进程允许其他人获得一个实际运行在您的计算机上的虚拟图形桌面)
*   **任务调度器**
    *   cron(及其变体，如 vixie-cron…)(这个守护进程在您的系统上运行定期任务，如更新搜索索引或联机帮助页索引，但也轮换日志文件。这通常是服务器系统正确运行所需要的，但是工作站没有它也能运行)

## 禁用守护程序

当使用 GUI 来管理在引导时启动的守护进程时，您通常可以通过取消选中复选框来禁用它们。使用 chkconfig 时，可以使用以下语法:

> [re chosen @ localhost ~]$/sbin/chkconfig name off

将“名称”替换为要禁用的守护程序的名称。如果您意外禁用了一个错误的守护程序，您可以通过以下方式再次打开它:

> [re chosen @ localhost ~]$/sbin/chk config 名称重置

你可能认为这不合逻辑，应该是:

> [re chosen @ localhost ~]$/sbin/chk config name on

嗯，不应该。上面的命令将为一组固定的运行级别启动守护程序，不管之前的值是什么。这并不完全是我们想要的，因为我们希望它切换回原来的状态。单词“reset”告诉 chkconfig 恢复 init 脚本中指定的值，该脚本包含如何启动守护程序的指令。这些值是(或者应该是)默认值。请记住，默认值并不总是等于旧值，但它们通常比“on”所暗示的值更接近旧值。您可能需要修改一些运行级别来纠正它。您可以通过指定应该更改哪些运行级别来做到这一点，如下所示:

> [re chosen @ localhost ~]$/sbin/chkconfig–35 级名称在

上面的命令将启动运行级别 3 和 5 的守护进程“name”。“–level”的参数只是一个运行级别数字的字符串，没有分隔符。另一个例子:

> [re chosen @ localhost ~]$/sbin/chkconfig–level 235 name on

## 第二部分:教程

这一部分将解释以上所有命令背后的内容。如果你想知道 Linux 如何“知道”在引导时启动什么，什么是“运行级”以及为什么通常有 7 个(或者，可以说是 8 个)，请继续阅读。注意:这个部分并不适合每个发行版。在这一点上，发行版之间有很多差异，所以我试图公开最默认的配置。

## Linux 如何“知道”在引导时启动什么

当您启动一台 Linux 计算机时，您通常会看到引导加载程序(在 BIOS 完成它的引导过程之后)。引导加载程序，通常是 [Lilo](https://lilo.go.dyndns.org/ "Go") 或 [GRUB](https://www.gnu.org/software/grub/ "Go") ，被配置为将 Linux 内核加载到计算机的内存中。然后，内核将引导加载器留在后面，继续自己引导，初始化硬件，并准备开始运行 init。init 是我们正在寻找的进程:它是第一个运行的进程，并且它产生所有其他进程。但是 init 想知道从哪里开始呢？简单的答案是:in /etc/rc*。d/(通常)。但这还不是完整的答案。为了了解它如何使用这些目录中的文件，我们首先需要了解什么是运行级别。

## 运行级别

运行级是系统可以驻留的进程状态。例如:运行级别 1 通常是救援模式，它引导系统启动尽可能少的进程，为用户提供根访问控制台，没有网络功能，也没有任何 GUI。另一方面，运行级别 5 通常是成熟的图形多用户模式。还有一些特殊的运行级别，您不应该引导到这些级别，但是您可以在引导后切换到这些级别:例如，切换到运行级别 0(零)会关闭您的计算机(在阅读完整的教程之前不要尝试这样做)，切换到运行级别 6 会让您的系统自动重新引导。现在来看看运行级别及其常见配置的完整列表:

*   0:关闭系统(引导后切换到)
*   1:将系统引导至救援模式
*   2:引导系统进入多用户模式，没有网络功能(一些系统，比如 Debian，使用这种模式作为成熟的模式)
*   3:将系统引导到具有网络功能的多用户模式(一些系统，如 Debian，将此作为成熟的模式)
*   4:通常不使用(有时与运行级别 5 或 3 相同)
*   5:将系统引导至成熟的图形多用户模式(当然，带网络)
*   6:重新引导系统(引导后切换到)
*   (S 或 S:通常类似或等于运行级别 1)

因为最后一个运行级并不总是被认为是真正的运行级(它被称为别名)，所以运行级的数量通常是七个，但也可以说是八个。启动后，您可以在所有运行级别之间切换，尽管 0 和 6(当然)需要您再次启动才能再次切换。运行级别之间的切换通常通过 init 命令完成，如下所示:

> [rechosen@localhost ~]$ init 3

上面的命令将(以 root 用户身份或使用 root 权限运行)将您的系统切换到运行级别 3，除非它已经在运行级别 3 下运行(如果您想切换到其他运行级别，请用其他数字替换 3)。在运行级别之间切换时，init 会终止在旧运行级别中运行的、不应该在新运行级别中运行的进程(在引导时这些进程为零，在关闭或重新引导时所有进程都为零)，并启动不在旧运行级别中运行的、应该在新运行级别中运行的进程(在关闭或重新引导时这些进程为零，但在引导时，这取决于您要引导到的运行级别)。现在我们可以继续 init“知道”什么开始什么停止的方式。

## 开始什么，停止什么？

当内核启动 init 进程时，它首先查看/etc/inittab 文件，看看在某个运行级别的情况下该做什么。这个文件通常告诉 init 在相应的/etc/rcX.d/目录中查找，其中 X 是运行级别。例如，当引导到运行级别 5 时，init 将运行/etc/rc5.d/ ( *请注意(再次)这并不适用于所有发行版*)中的脚本。这些“脚本”通常是指向/etc/init.d/(或/etc/rc.d/init.d/)中相应服务管理脚本的符号链接。但是这样的脚本如何理解 init 希望它启动还是停止服务呢？当 init 希望脚本启动进程时，它会以“start”作为第一个参数来运行脚本。当希望脚本停止服务时，init 将传递“stop”作为第一个参数。如果您想要启动或停止服务，也可以自己执行此操作。例如:

> [rechosen @ localhost ~]$/etc/init . d/ntpd stop

上面的例子将停止 ntpd 守护进程。要再次启动它，请使用以下命令:

> [re chosen @ localhost ~]$/etc/init . d/ntpd start

停止和启动通常可以通过以下方式结合起来。

> [re chosen @ localhost ~]$/etc/init . d/ntpd restart

如果您希望守护进程重新读取其配置文件，这将非常有用。根据为其编写脚本的服务(以及脚本本身)，还可能提供其他参数。无论如何，让我们回到/etc/rcX.d/目录。这个目录中充满了名为“K59somedaemon”和“S10anotherdaemon”的文件。我简单解释一下:

*   “K”表示“kill”，而“S”表示“start”:以“K”开头的符号链接将由 init 使用“stop”参数执行，以“S”开头的符号链接将使用“start”参数执行。
*   “K”或“S”后面的两位数字并没有什么真正特殊的含义，它们只是用来排序的。需要在某些其他符号链接之前运行的符号链接的数量应该比其他符号链接的数量少。
*   对于 init 来说，守护进程后面的名称实际上是不必要的，但是对于系统管理员来说，这是一个很好的实践，这样他们就可以立即看到符号链接的用途。

最后，你应该知道几乎所有的发行版都在某处进行了某种检查，以确保已经运行的进程不会再次启动(这将导致两个相互干扰的进程，除非守护进程自己检查是否没有其他实例在运行)，并且已经终止的进程不会被“重新终止”。这通常是由一些特殊的程序或脚本来完成的，它们被调用来完成实际的启动。

## 最后的话

嗯，我希望这篇教程能帮助你减少计算机的 CPU 负载和启动时间，并理解在你打开计算机后是什么让 Linux 系统启动的。如果您有任何建议(例如:在某些情况下似乎不必要的另一个守护进程或管理守护进程启动的另一种方法),请留下评论。