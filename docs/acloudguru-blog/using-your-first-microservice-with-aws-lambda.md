# 将您的首个微服务与 AWS Lambda 一起使用

> 原文：<https://acloudguru.com/blog/engineering/using-your-first-microservice-with-aws-lambda>

基础设施可能令人生畏。AWS 成为世界上最受欢迎的云平台是有原因的——这很复杂。这种复杂性使得 AWS 如此强大，但对于那些还没有使用过类似工具的人来说，这也是一个巨大的障碍。我们已经谈了很多关于了解 AWS 平台的价值，但是[知道从哪里开始](https://linuxacademy.com/blog/certifications/getting-started-with-aws-certifications/)本身就是一个问题。在本指南中，我想回到 web 开发的基础上，谈谈如何使用 AWS 上托管的微服务。为此，我们将创建一个简单的 web 页面，它使用一个无服务器的联系表单，允许您的用户向您发送电子邮件。

## 这本指南是给谁的？

当我们谈论学习 AWS 时，我们经常谈论如何使用它来启动系统管理或运营方面的新职业。当然，这个平台不仅仅用于“后端”或“系统”工作。像 AWS Lambda 这样的服务需要集成到前端，因为 AWS 应用如此广泛，所以 web 开发人员熟悉它的工作方式非常重要。本指南是为那些想了解更多关于[微服务架构](https://acloudguru.com/blog/engineering/evolution-of-business-logic-from-monoliths-through-microservices-to-functions)的 web 开发人员准备的，但是他们还没有准备好从头开始学习整个 AWS 平台。

### 先决条件

微服务这个词听起来很复杂，但你不需要成为专家就可以开始使用它们。但是，您确实需要一些东西来开始:

*   **一个 AWS 账户**——你可以在这里免费创建一个[。](https://aws.amazon.com/)
*   **一个要使用的微服务**——我们之前发布过一个关于使用 AWS Lambda 创建无服务器联系表单的 [***指南。这是我们将集成到页面中的内容(我们建议您在阅读本指南之前先阅读该指南)，但我们讨论的原则和概念也适用于其他基于 AWS Lambda 和 API Gateway 的微服务。***](https://wpengine.linuxacademy.com/linux-academy/how-to-build-a-serverless-contact-form-on-aws/)
*   **一些 JavaScript 知识**–我们将使用 JavaScript 从浏览器与我们的微服务进行交互，因此您应该熟悉 DOM 交互和 AJAX 请求等中级概念，以便充分利用本指南。

## 我们会做什么？

在本指南中，我们将把现有的联系表单微服务集成到网页中。在开始之前，请确保遵循我们关于 ***创建无服务器联系表单*** 的指南。该指南处理 AWS 上的“后端”设置，本指南将解释如何将其集成到现有站点中。当我们完成时，您将有一个联系表单，它调用 AWS Lambda 函数，允许您的用户通过您站点上的表单向您发送电子邮件。

## 什么是微服务？

这个问题可以作为一个指南，但是在我们开始之前理解它是很重要的。*微服务架构*意味着你的基础设施(托管你的应用的服务器)由小的、大部分独立的部分组成，每个部分负责一个特定的任务。当您编写应用程序时，您使用函数来执行某些任务，并在代码库中划分职责。打个粗略的比方，微服务之于基础设施，就像功能之于代码一样。假设您的应用程序崩溃了。如果您的代码库足够大，隔离和修复问题可能需要大量的工作——并且您可能无法让您的应用程序重新上线，直到您这样做。借助微服务架构——使用单独的基础设施来处理不同的任务——您通常可以在修复一个特定问题时让应用程序的其余部分保持运行。问题是孤立的，对代码的其余部分几乎没有影响。你可能听说过像**无服务器**或者**功能即服务**这样的术语。Lambda 是 Amazon 对这些概念的实现，微服务架构是一种可以用来改进站点或应用程序的方式。

## 集成您的首个微服务

If you haven’t created your infrastructure in AWS, be sure to do that first. Our guide to setting up your serverless contact form can be found **[here](https://linuxacademy.com/blog/linux-academy/how-to-build-a-serverless-contact-form-on-aws/)**. If you’re creating your first AWS account (or using one created in the last 12 months), all the services we use will be included in the [free tier](https://aws.amazon.com/free/?nc2), so it won’t cost you anything to follow along and try it out.The AWS infrastructure serves as your “backend,” but you also need a form to allow users to input information. Here’s a simple web page that we’ll use to illustrate how to make it work:If you’d like to follow along, paste the code above into a text editor open it in your browser. You’ll see something like this:![A basic contact form](img/4febaebd60ffe056c7bd895b4d92a7a2.png)Now let’s break down each part of the script, step by step. This isn’t meant to be the *most efficient* implementation, but I wrote out the code to explicitly show all of the component parts. There are [frameworks](https://serverless.com/) that can do the same thing, but the goal here is to illustrate what’s going on with a series of easy-to-follow steps. We won’t go over the HTML structure of the page, since that part will be up to you when designing your application.First, we need to enable to form to do something when it gets submitted:This will probably look familiar – we’re just adding an event listener onto the form. When it gets submitted, the sendDataToLambda function will be called. Further down in the code, we define that function. You can ignore the e.preventDefault() line at the beginning of the function – it prevents the page from reloading on submission, which makes testing easier – and continue down to the first three variables we create:This part should also look familiar. When the form is submitted, one of the first things we need to do is grab the values of each input field. Because of the way we created our Lambda function, it expects three values: the user’s email address, the subject of the email, and the body of the message.Up until now we’ve been dealing with concepts you’ve probably seen before, but next, we’ll begin to see how Lambda comes into play.This line defines our endpoint. If you’ve done much web development, you’ve probably used an API before (Google Maps or Yelp, for example). Our serverless contact form works in a very similar way. When we created our Lambda function, we set the API Gateway service to be its *trigger.* You can think of API Gateway as a managed API service. It listens for HTTP(S) requests, and does something when it receives them. In this case, it invokes our Lambda function to send an email.To find your endpoint, navigate to **API Gateway** in the AWS web console. In the menu on the left, select the “*contact*” API we created, and click *Stages.* Select the “prod” stage, and copy the *Invoke URL *shown in the blue box at the top of the page. That’s the base of your URL – you’ll also need to add a *resource*. If you followed along in our initial guide, we named this “/*ContactFormLambda*” but you can find it in the *Resources* section under your “*contact*” API if you called it something else.To summarize, your endpoint is made up of both the invoke URL and the resource name. If you try to run your function from the browser and get a “Missing Authentication Token” error, this is a good place to check first.Next, we’ll construct an object:This object is what we’ll use as the body of our HTTP request to the API Gateway. We’re using the three required fields that our Lambda function expects to receive, along with the values we got from our user input fields earlier.The next step *instantiates* (creates) our request. This might look unfamiliar, so let’s break down why we’re doing it this way:This is a Request object, and it’s specific to the **Fetch** browser API. If you are familiar with AJAX, you may have used jQuery’s .ajax() method or the browser’s native XMLHttpRequest (XHR) object to make server requests. Fetch does most of the same things, but it’s a little more modern and, in my opinion, easier to use.We’re creating a new instance of Request, which takes two parameters. First, the endpoint where the request will be made (our API Gateway route), and second, an object containing some information about the request. Since we’re sending data *to* our endpoint, we’re using the “POST” method. We also need to convert the body of our request to a string so that Lambda can understand it (our Lambda function expects a string, but will parse it as JSON when it gets called – see the Lambda code for details on how this happens).The other setting we’re using, “no-cors” mode, is for local development. It allows us test our code while avoiding some default security features of the Fetch API.  We’ll talk more about what this means in the next section.Finally, we put everything together into a Fetch call:This is where we make our request, which is described by the Request object we created above. The second and third lines are where we’d handle errors – this syntax is used because Fetch resolves with a JavaScript Promise. For your application, you’ll probably want to write some custom code here, but we’ll just log the results for the sake of example.And that’s it! With this code in place, you can enter some test data in the form, and submit it.![Submitting data to the serverless contact form](img/5bfe6bbd461dc59502e634d13faa17da.png)Once you’ve done that, check the email account you verified with AWS, and you should see a new message with the information you provided:![The email message we receive from AWS](img/4a99f7cd12da3e66bfe870266bd8c43a.png)A couple final notes – you *will need to enter a valid email address in the email field*. SES does validate this section, and you’ll receive an error if it doesn’t detect a valid format. You’ll also notice that, after submitting your form, the response data that is supposed to logged to the console is incomplete. For example, you’ll see a “*status*” property of 0, rather than the actual HTTP status code (200 or 5xx). This is due to the “no-cors” mode we set on the request, which we’ll address next.

## 部署到生产

这种设置很适合测试，或者如果你只是想看看事情是如何工作的。但是，如果您准备在自己的网站上开始使用无服务器联系表单，您需要采取更多的步骤。首先，从你的请求对象中移除*模式:‘no-CORS’*。通常，您不能从本地计算机发出跨来源请求，因为它的来源设置为“null”将这个选项添加到请求中允许我们在本地测试，但是没有必要从您自己的站点进行调用。事实上，将它留在生产环境中可能会阻止您准确地处理 Fetch 响应中的错误——这将导致您得到一个不透明(空)的响应，并且您将无法访问诸如 HTTP 状态代码或错误消息之类的内容。最后，将 API Gateway 中的“Access-Control-Allow-Origin”头改为您的域名。要找到这个设置，在 API 网关控制台中打开您的 *"/ContactFormLambda"* 资源，点击页面顶部的**动作**菜单，并选择*启用 CORS。*本页的最后一个字段允许您将此标题设置为您将使用联系表单的站点的域名:![Setting your Access-Control-Allow-Origin header](img/a837c86a381ab69b9d3ea4662a5bf530.png)

## 那么，为什么这很重要呢？

我们之前谈过微服务架构的优势——它将您的服务分开，这样，如果一个服务出现故障，您的整个应用程序不会宕机。例如，除了联系表单之外，您还可以创建另一个从数据库中读取数据的微服务。如果其中一个服务崩溃，另一个服务可以继续运行，而不需要您登录到您的服务器并重新启动您的应用程序。另一个好处是开发速度。“正常的”架构需要更多的测试来确保新代码不会干扰现有的应用程序。例如，使用微服务，联系人电子邮件和数据库读取是完全独立的。您可以对一个服务进行更改，测试该服务，然后立即部署它。新服务可以在任何时候添加，而不必担心它们是否会引起重大变化。微服务，就像我们创建的联系人表单，也很容易集成到一个 [AWS 静态网站](https://acloudguru.com/hands-on-labs/create-a-static-website-using-amazon-s3)。在过去的几年里，静态站点生成器变得非常流行，这是有原因的——它们速度快、可维护，并且相对容易地创建一个不需要太多代码的漂亮站点。微服务允许你运行一个后端，而不需要所有的维护，这些维护会把人们从不受管理的主机上吓跑。在创建你的站点时，它们也提供了一个很好的中间地带——也许你不需要一个完整的 PHP 或 Rails 应用程序，但是一个静态站点是不够的。使用 AWS Lambda 的微服务允许您通过创建如上所示的脚本并将它们嵌入到静态页面中来处理传统的“服务器端”操作。

## 下一步是什么？

web 开发和 AWS 这样的复杂平台之间的联系并不总是一目了然。AWS 通常被认为是为管理员提供的一项服务，但是只要掌握一点知识，在自己的项目中使用它并不困难。我想澄清一些事情，我们在这里创建的不是一个完整的微服务架构。这只是一个如何构建一个的例子，并且只显示了一个组件。但是有了 AWS Lambda，创建更多像我们的联系表单提交这样的服务比以往任何时候都容易。因为 Lambda 以服务的形式提供功能，所以您可以更多地关注代码，而不是运行代码的基础设施。您可以按照我们的指南创建无服务器联系人表单，并对其进行修改以执行其他任务——使用 AWS 简单通知服务(SNS)发送短信可能是一个不错的下一步。AWS 提供几十种服务，所以如果你四处看看，你肯定会发现一些有趣的东西。**最好的学习方法是实践。**你可以阅读世界上所有的文档，但是除非你亲自动手，否则很难真正发展你的技能。如果这篇指南让你对 AWS 的强大感到兴奋，那么有很多项目你可以花很少的钱或者免费试用。我们在此创建的微服务受 AWS 免费层保护，该层适用于新 AWS 帐户，有效期为自创建之日起 12 个月。AWS 还发布了一份[静态虚拟主机指南](https://aws.amazon.com/getting-started/projects/host-static-website/)，其中包含每月 0.50 美元(是的，就是*美分*)的设置费用。重要的是进入并使用这些服务——知识和技能会随着经验而来。当然，如果你想要一个更正式的培训项目，这就是我们来这里的目的。我们的使命是帮助所有技能水平的人通过[真实世界场景和实践培训](https://linuxacademy.com/features/labs_exercises)学习云计算。如果您有任何问题，请在评论中告诉我们，或者更好的是，[注册一个免费的社区帐户](https://linuxacademy.com/join/pricing)，了解您的云学习之旅将带您走向何方。

### 进一步阅读

虽然本指南的范围仅限于微服务实现，但我们使用了一些 web 技术和概念，这可能需要一些额外的研究。这里有几个比我们在这里提供的更深入的链接:[那太好了](https://jakearchibald.com/2015/thats-so-fetch/)(归功于杰克·阿奇博尔德)[了解 CORS](https://spring.io/understanding/CORS) [AWS Lambda 深潜](https://linuxacademy.com/amazon-web-services/training/course/name/aws-lambda-deep-dive)