# 无服务器测试方法与众不同，实际上可能更容易

> 原文：<https://acloudguru.com/blog/engineering/testing-and-the-serverless-approach>

最近一直在想很多关于测试的事情。在工作中，由于增加了客户端应用程序和特性，我们最近大幅增加了 lambda 函数的数量。这不是一个开发新功能的大交易，但是有一些事情已经开始困扰我了(请原谅我的双关语)。

### 测试是一件“好事”

我完全支持创建测试。对我来说，这是否是真正的“测试驱动开发”——或者不管当今的测试方法是什么——都无关紧要。有时候，在初创公司，你只需要快速部署一些东西，然后编写测试(我知道，我知道——但我只是给从未在初创公司工作过的人提供真实世界的场景)。有时，测试永远不会被编写出来，因为你认为你的用例已经被捕获了(事实并非如此)。

通常，测试是因为生产环境中出现的错误而编写的。除非你有无穷无尽的金钱和时间，否则这种情况总是会发生的——在初创企业中你不会有。

测试至关重要。

但是如果你使用流行的测试智慧——无服务器很难。

### 测试与“全服务”架构的交互

[无服务器架构](https://acloudguru.com/blog/engineering/serverless-the-future-of-software-architecture)使用*大量的*服务——这就是为什么有些人更喜欢称该架构为“全服务”而不是无服务器。这些服务本质上是独立于您的测试机制的应用程序的元素。

*外部因素。*

一个好的外部服务将为你测试。这真的很重要。因为您不应该测试服务本身。你只需要测试你和它互动的效果。

这里有一个例子…

假设你有一个函数作为服务(比如 Lambda 函数)，你使用一个数据库服务(比如 DynamoDB)。您将需要测试函数与数据库服务的交互，以确保您的数据被正确保存/读取，并且您的函数可以处理来自服务的响应。

现在，上面的场景相对简单，因为您可以从本地机器上使用 DynamoDB，并运行单元测试来检查存储在数据库中的值。但是你发现了这个场景中的一些东西吗？这不是实时服务，而是它的副本。但是 API 是一样的。所以，只要 API 不变，我们就没事，对吗？

老实说，我已经意识到，如果我们使用 AWS 服务，AWS 很可能比我做得更好。因此，我们在单元测试中模拟我们与 AWS(和其他)服务的大部分交互。这使得开发一个逻辑功能和*单元测试*它变得相对简单——对所需的服务进行模拟。

这类似于使用 Rails 这样的框架。你不应该测试 ORM 的工作情况。那是 ORM 维护者的工作，不是你的。因此，顺理成章的是，如果一个服务提供了一个接口和关于接口如何工作的文档，那么它应该是好的——对吗？

*希望……*

### 除了单元测试之外，测试的其他部分呢？

这就是无服务器的问题所在…某种程度上。使用 FaaS 函数进行单元测试很容易，因为逻辑通常很小。在我看来，有一种过度依赖模仿的趋势，但它确实有效。

所有其他形式的测试都很难。事实上，我想说我们可能需要一个不同的范式来讨论这个问题。

通过多年来构建单一的应用程序，我们已经完全沉迷于某些类型的测试是绝对重要的——如果我们没有它们，我们就是“错误的”。

所以让我们稍微后退一步。

我们实际上已经讨论分布式系统和测试有一段时间了。[微服务模式](https://acloudguru.com/blog/engineering/how-the-saga-pattern-manages-failures-with-aws-lambda-and-step-functions)已经向我们表明，试图像测试 monolith 那样测试所有东西并不总是合适的，而且通常很昂贵。

使用微服务模式进行集成测试的关键是测试微服务及其与外部组件的集成。这很有趣，因为你还在想象某种分离。

在 Lambda 中，在这种情况下，每个 Lambda 都需要被视为微服务，然后进行测试。这意味着您的功能的单元测试(带有模拟)需要通过移除模拟，并使用实际的服务或以某种方式存根服务来扩展到集成测试。

不幸的是，并不是每个外部服务都可以用这种方式轻松测试。并不是每个服务都提供测试接口供您使用——也不是所有的服务都很容易隐藏自己。我会建议，如果一个服务不能为你提供一个相对容易的方法来测试现实中的接口，那么你应该考虑使用另一个。

当交易是金融交易时尤其如此。在这一点上，你不希望一个测试实际上花费你任何真正的钱！

### 超越单元和单一功能集成测试

对我来说，整体测试一个无服务器系统最简单的方法就是在一个非链接的 AWS 账户(或者其他云提供商)中生成一个单独的系统。然后使每个外部服务本质上链接到一个“测试”服务，或者尽可能地限制我们的暴露成本。

这是我实现它的方式——它依靠基础设施作为代码来实现它。因此，使用了类似地形或云层的东西。

但有趣的是，在微服务方法中，当你超越了像这样的单一功能时，你就开始了组件测试，然后是系统测试。从本质上来说，测试就是每次增加测试边界。从一个小的测试边界开始，然后逐步解决。

单元测试，然后集成，等等…

但有趣的是，我们的单元测试相当好地完成了测试每个功能边界的工作，此外还做了单元测试，并且相当好地测试了功能与外部服务的关系。所以下一步是一起测试服务的组合。

但是由于我们在大多数交互中使用外部服务，并且不经常从函数内部调用函数，因此测试边界实际上是相对不耦合的。

嗯……所以基本上，一个函数的逻辑与另一个函数的逻辑越不耦合，当我们在测试中向外移动时，测试边界就越近。

那么，在一个功能接一个功能地进行了良好的单元和集成测试之后，接下来会发生什么呢？接下来是简单的端到端测试吗？这变得非常有趣，因为这意味着用合理的数据在一个分级风格的环境中测试整个“分布式系统”。

### 等等！我们刚刚是不是…？

基本上，功能即服务方法所发生的事情是，测试套件似乎比您通常使用整体甚至微服务方法所做的要简单得多。

与微服务方法中的组件测试相比，FaaS 功能单元测试的测试界限似乎非常接近于集成测试。

> 快速警告:如果你做了大量的函数到函数的调用，那么你正在耦合那些函数，然后测试边界将会改变。函数调用函数会产生一个单独的测试边界。

这又回到了另一件非常有趣的事情上。如果您构建功能，并开发一种事件驱动的方法，利用第三方服务(如 SNS、DynamoDB 触发器、Kinesis、AWS 世界中的 SQS)作为连接“胶水”的事件，那么您可能会限制自己单独测试功能，然后测试系统。

### 嗯…所以测试更简单？

不完全是，但是接近了。

我认为系统测试更难。如果你纯粹使用一个 API 网关，而 Lambdas 在后面，那么你可以使用第三方工具来测试 HTTP 端点，并以这种方式构建一个测试套件。相对比较理解。

但是如果你正在做大量的内部事件触发，比如 DynamoDB 触发事件链和多个 lambdas 的设置，那么你必须做一些不同的事情。这种形式的测试更难，但是因为一切都是服务——包括 Lambda——所以做起来应该相对简单。

用无服务器构建这种系统测试工具的人会做得很好。目前，我们拥有的 CI/CD 工具和围绕它的测试工具还不够好。

### 测试和无服务器是不同的

当我开始思考这篇文章的时候，我期望弄清楚很多关于如何在我们的工作流程中安装更好的测试机制的事情。

在本文完成时，我们已经了解了为什么无服务器方法不同于整体式方法和微服务方法。结果，我意识到了测试较小的非耦合逻辑的固有优势。

你不能仅仅把你的旧的“Monoliths 测试工具箱”拖进无服务器的世界，然后期望它还能工作。

*在无服务器中测试是不同的。*

无服务器测试实际上可能更容易。

事实上，在无服务器环境下进行测试可能更容易维护。

但是我们目前缺乏真正实现价值的测试工具。—期待他们的到来。

### 一些最后的想法

我经常是一个不情愿的测试作者。我喜欢在构建要“工作”的东西之前，边做边摸索。我从来不是那种在任何情况下都要强制测试的人，所以我可能会忽略一些要点。肯定有人比我更有资格谈论测试，但这些只是对测试的简单想法。

* * *

## 获得更好职业所需的技能。

掌握现代技术技能，获得认证，提升您的职业生涯。无论您是新手还是经验丰富的专业人士，您都可以通过实践来学习，并在 ACG 的帮助下推进您的云计算职业生涯。

* * *

*附加资源*

[微服务架构中的测试策略——过去几年，基于服务的架构已经向更小、更集中的“微”架构转变——martinfowler.com](https://martinfowler.com/articles/microservice-testing/)

bliki:test pyramid—tags:[测试金字塔](https://martinfowler.com/bliki/TestPyramid.html)是由 Mike Cohn 开发的一个概念，在他的书《敏捷的成功》中有描述。它的本质……—martinfowler.com

[拒绝更多的端到端测试——迈克·威克在你人生的某个时刻，你可能会想起一部你和你的朋友都想看的电影……—testing.googleblog.com](https://testing.googleblog.com/2015/04/just-say-no-to-more-end-to-end-tests.html)