# 大规模流媒体视频:代码转换的故事

> 原文：<https://acloudguru.com/blog/engineering/streaming-video-at-scale-a-tale-of-transcoding-at-acg>

[视频转码](https://acloudguru.com/blog/engineering/easy-video-transcoding-in-aws)在我们学生使用云计算大师平台的体验中发挥了巨大作用。我们来自世界各地的学习者可以在他们的桌面、平板电脑或我们的移动应用程序上观看我们的内容。

还有相当多的云学习内容需要观看。现在，我们有 340 门课程，包含 11，050 个单独的课程。此外，还有 26 个网络系列，包含 503 个单独的系列视频。我们最近增加了动手实验内容，因此在此基础上又增加了大约 1，500 个视频。我们定期更新我们的目录。每个视频的长度从 2 到 20 分钟不等。视频内容真多啊！

在这篇文章中，我将分享我们如何处理代码转换的故事，看看从最开始到当前的实现是如何完成的。我们将探讨我们在此过程中遇到的问题和权衡，以及如何改进我们当前的解决方案。

## 但是什么是代码转换呢？

我听到你问，“为什么它很重要？”从很高的层面上来说，视频转码是将视频从其原始格式转换为另一种格式的过程，通常是将其缩小到更适合终端设备的格式或分辨率。该过程本身包括将视频文件从一种格式解码为未压缩格式，然后将未压缩数据编码为所需格式。

那么，为什么我们需要不同的视频格式和分辨率呢？我们希望能够在多种设备上兼容观看我们的内容，包括 PC、平板电脑、手机、智能冰箱等等。更重要的是，我们希望确保我们的用户能够在他们使用的任何设备上获得最佳的观看体验。

你可以想象一个 ACG 的学习者试图在一个低连接的地区用手机观看一个高清视频[云形成要点](https://acloud.guru/overview/intro-aws-cloudformation)会有一个非常糟糕的体验！

因此，我们拥有的选项越多，我们可以接触到的设备和用户就越多，每个人的体验也就越好。

## 我们一开始是怎么做的？

当然，一个云专家并没有一开始就有这么多的视频内容，而且我们当时也没有移动应用程序。

最开始，*回到 2015 年*，视频转码是一个手动过程。该团队会上传一个视频到一个名为手刹的程序，应用程序会对视频进行转码。

不用说，不久就需要一种新的方法！

## **介绍 AWS 弹性转码器**

我们是一家运行在亚马逊网络服务(AWS)上的无服务器商店，所以利用弹性转码器(AWS 在云中的媒体转码器)是非常明智的。它是 AWS 的第一个代码转换服务，现在已经在很多应用程序中使用。

与手刹一样，它将媒体文件从一种格式转换成可以在不同设备上播放的各种不同格式。

Elastic Transcoder 还为流行的输出格式提供了转码预设，因此您无需猜测哪些设置在特定设备上效果最佳。因此，无论是 iPhone、三星、Kindle 还是其他什么，它都迎合了这些设备的需求。

同年(2015 年)，对转码流程进行了改造。最初的过程完全是手动的，是时候实现自动化了！

通常，我们平台上的内容创建者需要转换至少 1080p(全高清分辨率)的 mp4 视频。当用户在桌面上观看我们的视频时，质量默认设置为 720p，这是标准的高清。我们还提供 1080p 和更低的 480p 作为播放选项。

### 我们的第一次实施效果如何？

1.  我们的内容团队将从编辑器 UI 上传一个 MP4 文件，并将其添加到我们的 S3 输入桶中。文件名中包含数据编码，因此看起来可能是这样的:*course/AWS-CsA/section-1/component-1 . MP4*

    文件名按课程、课程名称、部分和组件分类，因为您可能有多个视频组成一门课程的不同部分。

2.  上传到输入存储桶将触发 lambda 函数，该函数由输入 S3 存储桶中的 ObjectCreated 事件触发。

3.  lambda 将向 Firebase 写下处理状态，表示已经为该文件启动了新的代码转换作业。

4.  然后，lambda 会将 S3 对象密钥作为输入传递给弹性代码转换器，以处理 mp4。

5.  Elastic Transcoder 会将转码后的视频以我们指定的格式放入输出桶中。重要的是要注意，在这一点上，我们想要转码的配置在我们的源代码中是固定的。

6.  然后，我们有一个 lambda，它将由输出桶中的 ObjectCreated 事件触发，该事件将使用代码转换作业的状态“完成”来更新 Firebase。

7.  在整个过程中，数据被重新同步到浏览器(Firebase 有 websockets)。当代码转换器在后台工作时，状态在 Firebase 中更新，然后 Firebase 将状态推送到浏览器。

8.  最后，对于任何在平台上观看的学习者，他们将通过一个签名的 URL 访问内容。他们会看 1080p、780p 或 480p 的 mp4。

### **这种方法的问题**

在这个时候，我们正在引入 web 系列，这个架构与 Courses 和 Firebase 紧密耦合。我们知道，除了课程视频之外，我们还需要不同类型的内容，这个解决方案并不通用。

另一个问题是数据被编码到文件名中。因此，这个实现将基于文件名在服务中传递数据。这是它知道文件与特定课程中的特定视频相关的方式。这就是 Firebase 层次结构是如何确定的，它与具体的课程紧密耦合。

S3 支持元数据，所以我们可以通过键值对作为元数据添加这些数据，而不是从文件名中提取。视频预置被硬编码到源代码中，所以我们不能在整个过程中添加任意数据。如果我们想用不同的配置对视频进行转码，我们不能这样做，因为预置在源代码中是固定的。

我们也没有 DynamoDB 来查找或存储任何额外的数据——实际上你所拥有的只是在 lambda 函数中传递的文件名。

### 我们是如何摆脱这种局面的？

我们知道我们想要不同类型的内容，并且之前的设计将课程与 Firebase 紧密耦合，所以我们决定将内容的类型分离。现在，我们为网络系列和课程提供了不同的服务，还有一个进行代码转换的内容服务。

内容服务本身是通用的。它不知道视频内容是连续剧还是课程材料，也不知道连续剧还是课程服务，它只关注转码工作。

浏览器将调用内容服务，通过上传视频进行代码转换来创建一段内容，内容服务将返回一个 contentID。根据内容，该 contentID 将与网络系列服务中的一集或课程服务中的一节相关联。

### **窥探内容服务**

图中的内容服务是一个带有 GraphQL 端点的服务，它触发 lambdass，然后 lambda 根据请求与特定的 AWS 服务对话。我在这里用 GraphQL 标识来表示它。

在内容编辑器 UI 中，我们首先通过 GraphQL 变体/API 创建一段内容，这将触发一个处理程序将这段内容写入 DynamoDB。通过这个 API 调用，我们能够指定我们想要的视频定义/格式。比如我们可以通过 720p，1080p，mp3 等。而在之前的实现中，这个细节是在源代码中硬编码的。

接下来，内容服务创建一个预签名的 URL，这样内容只能由内容编辑上传到 S3 输入桶中。

现在，我们做代码转换！

1.  向 Elastic Transcoder 发送请求以启动作业，对内容进行代码转换。

2.  Elastic Transcoder 从 S3 输入桶中获取被请求转码的视频，并在作业完成后将转码后的视频文件放入 S3 输出桶中。

    随着代码转换过程的进行，Elastic Transcoder 使用作业状态更新 DynamoDB 表，因为它为您提供了作业的开始和结束事件。例如，一旦 Elastic Transcoder 完成了工作，它就会在 SNS 主题的有效负载中发送该状态。然后订阅该主题的 lambda 会去更新 DynamoDB。

3.  发生这种情况时，浏览器会轮询更新，以便用处理状态更新 UI。这取代了可用于 Firebase 的 web 套接字。我们现在已经从 Firebase 转移到 DynamoDB，这是我们做出的权衡。

4.一旦这项工作完成，转码后的文件将被放入 S3 输出桶，CloudFront 将为视频内容提供签名的 URL。这确保了我们的内容只对平台成员开放！

## **我们当前方法的问题**

这个解决方案的大部分是在云形成中，但不是全部！不幸的是，弹性代码转换器不是一个受支持的资源，所以我们不得不在控制台中手动设置它。

另外，弹性转码器服务现在已经过时了。有一个更新的服务我们可以用它来代替，我很快就会谈到它！

我们已经走了这么远，我们已经做出了改变，我们取得了什么成就？嗯，我们已经设法通过内容服务来集中我们所有的视频。每一点视频内容，不管它是为了什么(课程或网络系列，现在动手实验室)，都使用相同的接口进行转码。我们以前已经脱离了这种紧密耦合的解决方案。

## **展望未来**

我们如何改进当前的实施？我提到的弹性转码器已经过时了。这是第一个能够转码视频的 AWS 服务，但现在有一个更新的服务可以取代它——AWS Elemental media convert。

MediaConvert 可以做和弹性转码器一样的事情，甚至更多！它支持更多的输入和输出格式，以及 HEVC 和 H.264 压缩标准(Elastic Transcoder 仅支持 H.264)和其他新功能，包括视频质量改进、编解码器和其他附加功能。

它在 CloudFormation 中可用，所以我们将能够有一个完整的 IaC 解决方案，这太棒了！您可以在 Cloud Formation 中生成转码作业，以及队列和预置。

MediaConvert 的定价模式类似于弹性转码器，因此您可以按需购买，按需付费。并且速率基于输出视频的持续时间。使用 MediaConvert 要便宜得多，这对我们每个月的代码转换账单肯定有帮助！

我们现在已经为我们的内容提供了有效的代码转换服务，希望 MediaConvert 在不久的将来能够锦上添花！