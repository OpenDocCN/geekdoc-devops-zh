# 如何在 AWS 上构建无服务器联系表单

> 原文：<https://acloudguru.com/blog/engineering/how-to-build-a-serverless-contact-form-on-aws>

联系方式对所有网站来说都是至关重要的，无论大小。有许多服务可以将联系表单嵌入到您自己的网站中，但是本教程并不是要利用这些服务。相反，它是关于通过关注创建我们自己的联系表单架构的问题来学习少量的 Amazon Web 服务。在本指南结束时，我们将创建一个无服务器联系表单，并了解有关以下服务的更多信息:

*   API 网关
*   希腊字母的第 11 个
*   简单电子邮件服务

我们将创建一个 **API 网关** (APIGW) POST 端点，它将接受以下 JSON 请求体:`{“email”: <contact-email>,“subject”: <contact-subject>,“message”: <contact-message>}`这个端点将有一个 **Lambda** 函数，它将把请求体转换成电子邮件。该电子邮件请求将被发送到**简单电子邮件服务** (SES)进行交付。有了这些部分，我们就可以创建一个发送消息的联系表单。

## 配置简单电子邮件服务向我们发送电子邮件

在深入研究任何代码之前，我们需要配置简单的电子邮件服务(SES)。我们的 Lambda 函数将处理来自我们网站的消息，并通过 SES 发送电子邮件。SES 是一个发送和接收电子邮件的巧妙产品。它提供了高投递率、成本效益和非常可靠的电子邮件处理。在本帖中，我们将利用它来获取一条消息，并将其发送到我们自己的白名单电子邮件地址。对于我们正在创建的项目，我们可以在 ses 沙盒环境中做任何事情。沙盒环境有以下限制:

1.  只能向 SES 邮箱模拟器*或*发送电子邮件至您已验证的电子邮件地址或域。
2.  每天限发 200 封邮件。

如果您打算每天发送超过 200 封电子邮件，您将需要请求提高发送限额。一旦获得批准，该请求会将您从沙箱中移除。然而，对于这个项目，您在沙盒环境中会很好。要配置 SES 向您自己发送电子邮件，我们需要完成以下步骤:

1.  导航到 AWS 控制台中的简单电子邮件服务。
2.  点击**电子邮件地址**
3.  点击**验证新的电子邮件地址**
4.  输入您希望用于联系请求的电子邮件地址。
5.  点击**验证该电子邮件地址**
6.  检查您的电子邮件，查看主题为“亚马逊网络服务-电子邮件地址验证请求”的验证电子邮件
7.  单击电子邮件中的链接以确认您的电子邮件地址。

## 设置初始 Lambda 函数以响应 API 网关触发器

你的 SES 设置好了吗？您的电子邮件地址是经过验证的电子邮件地址，SES 可以向其发送电子邮件。那你已经取得了很大的进步。自 2014 年 11 月 Lambda 函数首次亮相以来，亚马逊网络服务已经简化了它们的创建。过去的情况是，为不同的 AWS 事件配置 Lambda 既繁琐又容易出错。如今，初始设置更加简化和用户友好。这对我们来说太棒了，但是要知道，我们将不得不做一些进一步的调整。但是首先，让我们设置初始 Lambda 并从 API 网关端点触发它。无服务器堆栈的主干是一个*事件*。事件启动计算资源的分配以完成某个操作。AWS 中的*触发器*是分配一个容器来执行 Lambda 函数中的代码的事件。在 AWS 中，Lambda 目前可以响应 17 种不同的事件。今天，我们通过 HTTP 端点利用 API 网关事件。可以把 HTTP 端点看作是 Lambda 函数的触发事件。该请求启动容器，并包含 Lambda 函数的输入事件。使用这个输入，我们可以在代码中处理消息。不如我们跳进去配置初始端点和 Lambda 函数:

1.  从 AWS 控制台导航到 Lambda。
2.  点击**创建功能**
3.  在蓝图输入中，输入“ *api*
4.  点击 NodeJs 6.10 中的蓝图“*微服务-http-端点*”。
5.  对于“API 名称”，点击**输入值**并输入“*联系人*
6.  对于“部署阶段”，保持默认的“*产品*”处于选中状态。
7.  对于“安全”，选择“*打开*
8.  点击**下一个**
9.  输入“ *ContactFormLambda* ”作为您的函数名。
10.  输入有意义的描述，如"*处理 APIGW 发布到/联系*
11.  运行时选择“ *Node.js 6.10* ”。
12.  现在，我们将在内联代码部分输入这个样板代码:
13.  在“Lambda 函数处理程序和角色”中，将处理程序留在“ *index.handler* ”。角色应为“*从模板创建新角色*”。对于角色名称，输入“ *ses-contact-form-lambda* ”。对于策略模板，选择“*简单微服务权限*”*注意:我们稍后将围绕这些方面进行更多配置。*
14.  点击**下一个**
15.  点击**创建功能**

通过完成此向导，我们将获得以下 AWS 资源:

*   代理 HTTP(S)请求的 API 网关端点。
*   API 网关端点触发的 Lambda 函数。
*   一个 IAM 角色" *ses-contact-form-lambda* "拥有 lambda 的基本执行策略。

还需要进一步的改进，但是我们现在已经有了无服务器联系流程所需的资源。

## 配置您的 IAM 角色以通过 SES 发送电子邮件

在开始编写 Lambda 函数之前，我们需要暂停一下，配置一下*ses-contact-form-Lambda*IAM 角色。目前，该角色不允许在 SES 中使用 sendEmail API。为了使它变得非常轻量级，我们将创建一个新的 IAM 策略，该策略只包含我们需要授予访问权限的 SES 上的 API。

1.  从 AWS 控制台导航到 IAM。
2.  点击**策略**
3.  点击**创建策略**
4.  选择“*创建您自己的策略*
5.  输入“*联系人-表单-发送-电子邮件-策略*”作为名称。
6.  按如下方式配置策略文档:
7.  点击**创建策略**

现在有了一个粒度策略，允许访问 ses:SendEmail API。将此策略附加到 *ses-contact-form-lambda* 角色:

1.  从 AWS 控制台导航到 IAM。
2.  点击**角色**
3.  在搜索中输入" *ses-contact-form-lambda* "
4.  点击*ses-联系人-表单-λ*角色。
5.  点击**附加保单**
6.  选择*联系人-表单-发送-邮件-政策*
7.  点击**附加策略**

随着 IAM 的这些变化，Lambda 函数现在可以访问 SES 的 SendEmail API。

## 从 Lambda 函数通过 SES 发送电子邮件

我们现在已经为您的无服务器联系流程完成了所有的基础架构部分。只需点击几个按钮，瞧，我们有了 API 网关、Lambda 函数和 IAM 角色。很圆滑，对吧？基础设施，在这一点上，还没有准备好黄金时间。我们一会儿就会这样做，但首先让我们添加通过 SES 从 Lambda 函数发送电子邮件的代码。我们的函数没有外部依赖性。因此，我们可以内联编辑代码。如果我们正在创建需要其他 NPM 模块的 Lambda 函数，我们将需要在 AWS 控制台之外进行开发。原因是当 zip 文件上传到 Lambda 时，必须包含 NPM 包。但这不是这个项目的重点。我们将内联编辑代码，因为我们没有外部依赖。

1.  从 AWS 控制台导航到 Lambda。
2.  点击 *ContactFormLambda* 功能。
3.  将以下代码输入行内编辑器:

在 56 行代码中，我们有获取 API 网关请求、解析电子邮件消息、然后利用 SES 向我们自己发送电子邮件所必需的代码。但是等等——这段代码到底做了什么？很高兴你问了。让我们分解有趣的部分，回顾一下正在发生的事情。从 Lambda 函数的顶部开始，声明了三个常量:有趣的是, *aws-sdk* 不是外部依赖。这个包在 Lambda 函数容器中是全局的，并且总是可用的。我们通过调用 AWS 来实例化一个 SES 客户端。SES() 。我们还申报了 sesConfirmedAddress 。这必须是您之前在设置 SES 时验证的电子邮件地址。函数 getEmailMessage 处理请求的主体。它解析来自 API 网关请求体的请求，并构建 sendEmail 请求。我们希望将电子邮件发送给自己，因此 ToAddresses 是我们之前验证的 ses 电子邮件。源必须是我们验证过的电子邮件，因为这也是发送的电子邮件。其余的我们从用户通过我们的 API 网关发送的 JSON 请求中获得。电子邮件的正文在消息属性中。电子邮件的主题在主题属性中。电子邮件的回复字段在用户传入的 email 属性中。这是我们函数的核心，主事件处理器。首先要做的是提取请求正文，因为它包含电子邮件、消息和电子邮件的主题。接下来，通过将请求传递给 getEmailMessage 函数来获取 sendEmailRequest 。有了请求，我们调用ses client . send email(params)API。我们追加了。promise() 方法告诉 SDK 我们想要一个承诺。 ***提示**:用 JavaScript 中的 aws-sdk，可以追加。promise()到任何 SDK 调用来获得一个承诺。*API 网关端点设置为 *LAMBDA_PROXY* 。这意味着 Lambda 函数必须构建并返回一个 HTTP 响应。对于我们的目的，返回 200 表示成功，500 表示错误就足够了。当 sendEmailPromise 解析成功时，返回 200。如果失败，邮件发送失败，所以返回 500。在这两种情况下，我们只改变*响应*的*状态码*并调用回调(空，响应)。您利用 LAMBDA 中的回调函数来表示成功或失败:*API Gateway 中的 LAMBDA_PROXY* 需要来自您的 Lambda 函数的 HTTP 响应。调用总是以回调(null，response) 结束。未能返回 HTTP 响应会导致 API Gateway 返回 502 错误网关。

## show time–测试您的端点的时间

您将 Lambda 函数代码更新为上面的代码。您已将 sesConfirmedAddress 设置为已验证的 SES 电子邮件。Lambda 的 IAM 角色可以访问简单电子邮件服务的 sendEmail API。我们剩下的就是测试看看它是否有效。正如一句老话所说，如果你没有测试过它，那么它是不起作用的。对于这个项目的目的，我说的是通过使用它和观察结果来验证它的工作。如果我们要构建一个完整的生产应用程序，我们应该在这里进行其他级别的测试。单元测试和集成测试是很好的补充。但是对于这个简单的联系流，让我们确保它从我们的 API 网关工作。

1.  从 AWS 控制台导航到 API 网关。
2.  点击*联系*API。
3.  点击“ */ContactFormLambda* ”资源下的任意。
4.  点击**测试**
5.  选择“过帐”作为方法。
6.  在请求正文中，输入以下内容:
7.  点击**测试**

在右边，我们将看到 API Gateway 调用 Lambda 函数的请求流。下面是我们在底层寻找的东西:

*   方法已完成，状态为:200 —太棒了，它成功了！检查你的电子邮件。
*   方法已完成，状态为:500 —该死，它坏了。该检查日志了。
*   方法已完成，状态为:502-配置错误。该检查日志了。

如果我们看到“可以出发”的标志，也就是 a 200，那么我们可以检查我们的电子邮件，确保它看起来像我们预期的那样。如果我们有别的东西，我们需要做一些调试。面对错误时首先要检查的是什么？日志。但是原木住在哪里呢？对于每个 Lambda 调用，都有一个关联的 **CloudWatch** 日志流。以下是找到它的方法:

1.  从 AWS 控制台导航到 CloudWatch。
2.  点击**日志**
3.  在“日志组名前缀”中输入“*/AWS/lambda/contact form lambda*
4.  点击“*/AWS/lambda/contact form lambda*

一旦我们点击进入日志组，我们将看到我们的 Lambda 函数的日志流。最上面的是最近的调用。任何 Lambda 函数调用中的错误都会记录在日志流中。在日志流中，我们可以查看错误。搜索日志记录语句，并查看给定调用使用了多少内存和时间。因此，如果我们得到了除了 200 响应代码之外的任何东西，请通过检查日志来开始调试。如果日志没有揭示任何信息，那么我们应该检查我们设置的其余部分。需要注意的事项:

*   出乎意料的错别字
*   没有将正确的 IAM 策略分配给正确的 IAM 角色
*   Lambda 函数配置错误–内存分配或时间分配不正确

## 启用 CORS 并发布您的 API

在您的功能 API 为狂野的西部做好准备之前，您还有一些最后的问题要解决。我们需要做的第一件事是在我们的 API 端点上启用*跨源资源共享(CORS)* 。这将授予端点对我们指定的域的访问权限。最后一件事是将我们的 API 发布到公共平台。首先，让我们打开该端点的 CORS:

1.  从 AWS 控制台导航到 API 网关。
2.  点击*联系*API。
3.  点击 *ContactFormLambda* 资源。
4.  点击**动作**
5.  选择*启用 CORS*
6.  在“*访问-控制-允许-来源*”中，输入您将从其呼叫该端点的网站的 URL。如果您不确定，请将其保留为' * '，这将允许任何域。
7.  点击**启用 CORS…**
8.  点击**是，替换现有值**

启用 CORS 后，剩下的唯一事情就是将端点发布到一个*阶段*(也就是一个环境)。

1.  从 AWS 控制台导航到 API 网关。
2.  点击*联系*API。
3.  点击 *ContactFormLambda* 资源。
4.  点击**动作**
5.  点击**部署 API**
6.  从部署阶段选择*产品*。
7.  点击**部署**

一旦部署，我们的 API 现在就存在于 *prod* 环境中。我们将会有一个类似于 https:// <的 URL。execute-api.us-west-2.amazonaws.com/prod/ContactFormLambda

## 综合

至此，我们有了一个功能性的无服务器联系流程。API 网关调用一个 Lambda 函数。该函数接收请求体，并通过简单的电子邮件服务发送出去。下一步是将您的这个新 API 集成到您选择的东西中。你可以从自己的网站或作品集页面开始。要集成它，创建一个表单，其字段与请求正文要求的字段相同——用户回复的电子邮件地址、主题和正文。在表单提交时，用 JavaScript 在请求体中添加一个快速 AJAX 请求，您就可以开始比赛了。**更新:**我们已经创建了一个后续指南，从我们离开这里的地方继续，并将服务集成到一个网页中。你可以在这里查看。

## 结论

AWS 周围有大量的信息。以至于在试图学习它时很容易迷失。学习任何东西的最好方法是开始使用它。通过在实际问题中使用 API Gateway、Lambda 和 SES，您已经了解了它们的概念。这是我第一次学习 AWS 的方式。作为一名认证的专业解决方案架构师，这是我至今仍在做的事情。如果你有任何问题，请随时联系我。如果你想通过创建更多这样的项目来了解 AWS，可以看看我即将出版的书，[如何在 Amazon Web Services 上托管、交付和保护静态网站](https://www.kylegalbraith.com/learn-aws/)。

* * *

通过在 [Twitter](https://twitter.com/kylegalbraith) 、 [LinkedIn](https://www.linkedin.com/in/kylegalbraith459/) 和 [Medium](https://medium.com/@kyle.galbraith) 上关注凯尔，跟上他正在进行的其他项目。