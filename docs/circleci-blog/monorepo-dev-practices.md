# monorepo 开发实践的优势和挑战| CircleCI

> 原文：<https://circleci.com/blog/monorepo-dev-practices/>

在一个单一的整体存储库中，也称为 monorepo，您将所有应用程序和微服务代码保存在同一个源代码存储库中(通常是 Git)。通常，团队将各种应用程序组件的代码拆分到子文件夹中，并使用 Git 工作流来获得新功能或错误修复。这种方法对于大多数使用整体架构开发的应用程序或系统来说是很自然的。

这种 **monorepo 代码通常只有一个生成应用程序可执行文件的构建管道。**虽然维护很简单，但是这种方法降低了整体速度，因为一些难以修复的 bug 会阻止团队将候选发布部署到产品中。

本文概述了 monorepos 和 polyrepos 之间的区别，权衡了 monorepos 的利弊，并帮助您确定 monorepo 是否是您团队的最佳选择。

## 面向微服务的 Monorepo 与 polyrepo

随着[微服务架构](https://circleci.com/blog/soa-vs-microservices/)变得越来越流行，团队倾向于将他们的代码分成许多存储库(polyrepos)。团队独立开发微服务，使用不同的、特定问题的工具和编程语言。例如，一些开发人员可能使用像 Python 这样的开源项目进行人工智能(AI)，而其他人则使用 Java 或。NET 来实现 API。

polyrepos 的优势显而易见。一个小团队可以快速实现并独立部署高速软件开发的微服务。

然而，使用独立的存储库会带来风险。系统知识分布在由不同团队维护的多个回购协议中。**在某些时候，你意识到没有人知道如何构建和部署整个系统。**

虽然 polyrepos 似乎是微服务的自然选择，但具有统一和自动化构建和部署管道的 monorepo 可以缓解许多问题。仔细看看 monorepo 的好处以及一些误解，可能有助于您决定 mono repo 环境是否最适合您的团队。

## monrepos 的好处

单一回购方式有几个优点:

*   **易见。**如果你正在做一个调用其他微服务的微服务，你可以看看代码，了解它是如何工作的，确定 bug 是发生在你自己的代码中，还是发生在另一个团队的微服务中。
*   **代码共享。团队为各种微服务复制代码会导致额外的工程开销。如果公共模型、共享库和助手代码都存储在一个存储库中，团队可以在许多微服务之间共享它们。**
*   **改善协作。**mono repo 消除了团队之间的障碍和孤岛，使设计和维护协同工作的多组微服务变得更加容易。
*   **标准化。**使用 monorepos，跨团队标准化代码和工具变得更加容易。您可以实施分支策略来保持主分支的整洁，限制对特定分支的访问，强制实施命名准则，包括代码审查人员，以及强制实施最佳实践。分支策略将进行中的工作与已完成的工作隔离开来。
*   **可发现性。monorepo 提供了整个代码的单一视图。您可以在 monorepos 中查看整个存储库的状态，筛选所有分支，并跟踪修改，这比在 polyrepos 中容易得多。**
*   **发布管理。**mono repo 保留关于如何部署整个系统的所有信息。自动化的构建和部署管道不会像在 polyrepo 中那样隐藏每个团队内部的部署知识。
*   更简单的重构。直接访问所有微服务使得在 monorepo 中重构代码更加容易。此外，您可以更改代码结构。在文件夹和子文件夹之间移动源代码要比在多个存储库之间移动源代码容易得多。

## 蒙雷波斯的挑战

尽管有这些好处，monorepos 也带来了一些挑战。更改公共代码会影响许多应用程序组件，并且源冲突可能很难合并。您的部署过程可能更具挑战性，并且您需要扩展您的源代码控制管理系统。

根据你的情况，monorepos 的好处可能会超过它们的挑战。

## 对 monrepos 的误解

如果你一直在微服务架构中开发应用，你可能对 monorepos 有一些误解。一些开发人员认为，由于难以创建统一的构建过程，多种编程语言和工具阻止了使用单个 repo。您可以通过使用[容器](https://circleci.com/blog/benefits-of-containerization/)来缓解这一问题，将每个微服务构建到容器映像中，然后作为一个单独的单元进行部署。

一旦你容器化了微服务，你也可以单独测试它们。因此，您可以将所有构建阶段保存在 monorepo 中，而不是保存在许多存储库中。唯一的区别是您的构建目标被设置为容器。

通常，开发人员认为 monorepos 会导致紧密耦合的代码。不尽然，但是您必须运用良好的判断力来防止代码陷入混乱。

开发微服务的时候，你让他们独立，这样他们就不依赖其他微服务了。当您的团队遵循微服务开发的最佳实践和指南时，您可以在 monorepo 中实现这一点。

这个想法是将一个大系统分成可独立部署的、松散耦合的单元，与组件不同，这些单元通过流程边界相互通信(通常使用 REST APIs)。尽管 monorepo 使得打破微服务架构模式变得很容易，但它本身不会导致紧密耦合的代码。

你应该独立地更新微服务，但是你可能认为这对于 monorepo 是不可能的。通过用更高级的部署策略(如[蓝绿色或金丝雀色](https://circleci.com/blog/canary-vs-blue-green-downtime/))取代滚动更新来应对这一挑战。您可以将新版本与旧版本并行部署，同时确保新的微服务版本按预期工作。如果您检测到一个 bug，您可以快速将流量重定向到以前的版本。

自动化[持续集成和持续部署(CI/CD)管道](https://circleci.com/blog/what-is-a-ci-cd-pipeline/)有助于应对所有这些 monorepo 挑战。每个开发团队可以独立工作微服务，构建其容器映像，并在不影响其他团队的情况下部署它。在将微服务投入生产之前，他们可以在测试环境中对其进行验证，并保持新旧版本的可用性。**容器化让你可以独立地部署和测试微服务，而不用担心它们不同的工具和编程语言。**

CI/CD 工具可以自动扩展并帮助您管理复杂的部署，以便您可以在更大的 monorepo 中构建、测试甚至部署单个微服务。

## 决定适合你的团队的策略

您如何决定在微服务开发中使用 monorepo 还是 polyrepo？**首先，评估你的团队文化**:它适合 monorepo 鼓励的协作开发吗？

**其次，评估你团队的纪律**:他们能够避免创建紧密耦合的代码吗？他们需要避免让自己的微服务依赖 monorepo 中的其他微服务。请记住，您可以通过[分支策略和权限限制](https://circleci.com/blog/access-control-cicd/)来实施这一原则，控制谁可以将微服务部署到生产环境中。权限决定了哪些团队和团队成员可以部署每项服务。

您可以通过一个统一的自动化 CI/CD 管道来实施所有这些实践，您的团队可以在一个更大的 monorepo 中构建、测试和部署各个微服务。自动化管道使管理 monorepo 变得更加容易，同时保持快速的部署速度。

## 结论

Monorepos 有很多优势，比如可见性、协作和代码共享，但它们并不适合每个团队。了解你的团队的优势和劣势，以确定单一回购是否是正确的选择。

如果您决定使用 monorepo，请保持您的高速软件部署，并通过统一的自动化 CI/CD 管道减少常见的微服务缺陷。您可以马上开始，今天就注册您的 [CircleCI 免费试用](https://circleci.com/signup/)。