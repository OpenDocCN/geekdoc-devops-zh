# 使用变化驱动的设计构建弹性架构

> 原文：<https://circleci.com/blog/letting-change-and-uncertainty-advance-your-software-architecture/>

CircleCI 代码库的第一行是在近九年前编写的。事后清楚地回顾我们迄今为止所建立的东西，揭示了一些有趣的主题，这些主题对于确定应对变化的方法是有指导意义的。虽然它们并非都是有意的，但这并不会降低它们的价值。三个这样的主题是:推迟处理变化的需要，像产品经理一样思考，保持头脑清醒。

## 变化是技术的永恒

在工程师的职业生涯中，变化可能是唯一需要处理的常量之一。这无疑推动了我们许多最有趣的挑战。市场在变化，我们的业务在发展，我们的客户群在增长，我们的团队也在壮大。我们需要构建一个既能满足当前需求，又能满足未来需求的解决方案。当我们开始构建系统时，我们如何设计我们的系统来适应和改变甚至不存在的事物？

最近几年，有很多关于架构的讨论，这些架构是专门为发展或更容易适应变化而设计的。然后，我们开始讨论这些架构的优点，使用一种思路，表明您正在选择“微服务架构”、“事件驱动架构”或“无服务器架构”。我认为这种类型的描述创造了一种虚假的终结感，这种感觉在大多数现实世界的系统中并不存在。

除了最年轻的项目，你不太可能用任何简单的一行程序来描述你的架构。它更有可能只是“你的架构”，如果你已经在它上面工作了很长时间，你可能已经应用了多种不同的模式来解决特定的问题。某处可能有一个整体、一些微服务、一些事件和一两个无服务器元素。最重要的是，您可能正在将这些部分从一种模式转换到另一种模式。

### 设计架构来解决问题

人们经常问我他们应该选择哪种架构，或者何时应该从一种架构切换到另一种架构。我很容易对类似“你想解决什么问题？”这样的回答感到失望

那么，随着产品的发展和需求的变化，你应该考虑什么呢？

我们可以使用很多方法来设计软件和系统，使其更能适应变化。不必进行复杂的重构或重新构建的诱惑让我们想要设计变更成本低的系统。另一方面，虽然通用抽象和可重用组件是减少变更影响的核心，但它们很难一开始就正确处理。

### 很难预测未来

在技术领域不断变化的同时，您的业务和组织也在不断发展。这两者对您的架构决策都有重大影响。您正在经历的特定类型的变更将影响最适合吸收这些变更的软件架构。

在一个项目或一家公司的早期，有可能对目标进行彻底的根本性转变。极端但并不罕见的例子包括 Tiny Speck 变得 Slack 和 Odeo 变成 Twitter。当你的业务领域发生如此剧烈的变化时，你的 DDD 模式的清晰界限就不复存在了。在一组微服务中，这些边界将被编码，所以如果你必须穿过它们，你可能会感谢一个更柔韧的整体。

一旦你找到合适的产品/市场，你的重点将转向支持你的快速增长。随着系统规模成为变革的驱动力，响应变革的能力通常与基于其操作特征的系统独立性联系在一起。

在这个扩展阶段之后，你将拥有一个更大的组织和更多的团队。如果你幸运的话，你将回到可持续的产品进化。那么变更的成本将与进行变更所需的跨团队协调的数量成比例。

## 推迟对变更的响应

当个人或团队试图解决一个问题时，他们通常会从一个非常简单的指令开始——让我们来解决这个问题。我们可以用什么最有效的架构来以最低的成本构建可行的产品？无论是初创公司还是庞大的跨国公司，一般都是这样。一个新的项目将建立在一个相对较新的系统上，并且不太可能适合产品市场，因为公司还没有完全理解其业务领域，也不知道变化的主要来源将来自哪里。

在这种情况下，为变化而设计变得更加困难。如果使事物适应变化的成本要高得多，并且您还不能告诉您系统的哪些部分将会改变，那么您如何决定在哪里进行投资呢？

尽管听起来有些违反直觉，但答案可能是不存在的。至少现在还没有。相反，密切关注变化，并以最小化犯错成本的方式进行构建。

在“[每个软件架构师都应该知道的 97 件事](http://shop.oreilly.com/product/9780596522704.do)中，[Kevlin Henney 描述了一种考虑不确定性的重要方法](https://medium.com/@kevlinhenney/https-medium-com-kevlinhenney-use-uncertainty-as-a-driver-493ebebd575d):

> “两个选项的存在表明你需要在设计中考虑不确定性。将不确定性作为一个驱动因素来决定在哪里可以推迟对细节的承诺，在哪里可以划分和抽象以降低设计决策的重要性。如果你把想到的第一件事硬连线，你更有可能被它困住——偶然的决定变得重要，软件的柔软变得僵硬。”

这种框架对于明确的决策非常有用，但是如果你不知道你正在做一个选择呢？

很多时候，选择甚至还不可见，但以后会自己显现出来。在这些情况下，答案是不要过度概括，到处构建抽象以防万一。相反，让事情尽可能简单，这样你就可以在以后需要做出改变的时候理解它们。

### 简单使它更容易适应变化

在早期，CircleCI 应用程序是一个整体，它将客户的构建及其相关数据放入几个 LXC 容器中的一个。我们构建的每个容器都是从同一个映像实例化而来的，该映像包含了我们认为任何人在他们的测试环境中都想要的所有东西。事后看来，这听起来像是一个可怕的想法，但在当时，这是梦幻般的。维护和支持我们早期客户的需求很简单，他们中的许多人都在构建 Rails monoliths。

随着时间的推移和我们客户群的增长，他们在测试环境方面的需求也越来越多样化。他们的底层数据库的升级版本、新颖的新开发框架、甚至新的操作系统版本变得必要。

CircleCI 中最初的容器管理不是以允许我们容易地适应这些变化的需求的方式设计的。但这很简单。因此，当我们着手解决这些问题时，我们知道在新的方法中何处拼接，并且实现拼接是最简单的工作。我们也不需要解释一个不支持我们新问题的糟糕的概括。

值得注意的是，虽然看起来很简单，但在我们的第一批客户测试其替代品之前，我们已经成功发展了五年，在这个简单的系统上满足了客户的需求。在那五年里，Docker 和 HashiCorp 的 Nomad 都被创建了。结合起来，这些工具消除了获得我们今天为客户支持的灵活且可扩展的环境所需的大量工作。

此外，当我们重组系统以适应变化的市场时，我们可以问“我们如何才能更好地适应增量变化？”在设计解决方案时，很难夸大五年的经验所提供的价值。

这么说听起来很奇怪，也非常不公平，但是大多数时候我们甚至不知道我们正在做一个重大的设计决策，因为备选路径还没有出现。你如何防范这种情况？

### 推迟，推迟，推迟

如果你能找到一种等待足够长时间的方法，正确的解决方案往往会自己显现出来。技术要么获得牵引力，要么消亡。如果你在 2016 年选择了一个容器编排引擎，你有大约 20%的机会选择 Kubernetes。这意味着到 2018 年初，几乎 80%的公司都在转换。这种可能性不大。

所以推迟可能是好的。推迟到制造危机的时候就不是了。

## 像产品经理一样思考

你的架构是一个有漏洞的抽象。虽然 CircleCI 可能是这种情况的一个极端例子，因为我们的客户可以访问我们平台中的系统，但客户在定义您的架构时所做的决策总会有一些影响。认识到这种影响并能够连贯地讨论方法和备选方案是工程师可以带给他们的 PM 和团队的巨大财富。

当我们目睹客户构建软件方式的所有这些变化时，有一件事我们忽略了太久，那就是 Docker 的崛起。当 CircleCI 在 2011 年成立时，Docker 甚至还不存在，但到了 2014 年，它已经无处不在。我们的许多客户已经开始构建 Docker 映像，作为准备部署的一部分。

Docker 最初构建于 LXC 之上，这意味着在早期，我们可以支持使用 Docker 命令来构建映像，并将它们推送到我们的一个 LXC 容器内的存储库。2014 年，Docker 推出了一种名为 libcontainer 的东西，他们剥离了对底层系统的访问，并创建了执行驱动程序，这很快导致了 LXC 驱动程序的过时。令人失望，但它仍然有效。然后 Docker 删除了所有 LXC 支持。那很糟糕。

### 永远为用户着想

作为工程师和架构师，我们看到了这一点，坦率地说，这是在我们产品团队的雷达下。我们的非技术产品人员不一定理解其中的含义，但我们的工程师每天都在谈论它。因此，作为一名工程师、建筑师或技术领导者，你需要思考产品的方向，并与产品经理合作，确保每个人都理解技术选择的含义。

将这种讨论与技术投资分开是很重要的。这种类型的投资绝对有一席之地，而且，有一种观点认为，用设计产品投资的同样方式来设计这些投资，可以更容易地做出权衡决策。然而，确定体系结构选择对客户直接可见的特性的影响不同于通常讨论的成本、性能、安全性等的影响。

更好地理解您的架构和您的客户所实现的价值之间的关系，将使您能够随着业务的发展，就构建什么和如何构建做出更明智的决策。然后你就可以专注于走在进化的前面。

## 抬起你的头

我是加拿大人，不出所料，我是打冰球长大的。在我的童年，我花了无数的时间练习滑冰:向前，向后，转弯，停下，绕着圆锥体做 8 字形。然后是棍子处理。我的想法是让冰上的运动成为第二天性，这样我就可以专注于真正重要的事情:看比赛进展，进入空间，并试图得分。让基础变得几乎毫不费力，这样你就可以把你的精力放在新的东西上。

在软件领域，我们有一个不好的倾向，那就是通过采用我们认为将会改变游戏规则的新技术，使基础变得更加困难，但最终却只有适度的上升。更糟糕的是，当我们让我们的团队沿着学习曲线前进，在生产事件中发现未经测试的边缘案例，并发明我们自己的“最佳实践”时，负面影响往往是无限的堆栈溢出没有答案的世界。

当我们将这种努力投入到我们的新技术中时，我们并没有关注我们的系统需要如何发展来满足我们客户的需求。

### 一个简单的时代会有所帮助

CircleCI 是一家 Clojure 商店，在早期，我们决定如果我们使用与后端相同的语言，我们会在前端开发方面做得更好。所以我们采用了 Om，一个围绕 React 的 ClojureScript 包装器。几年后，Om 的创始人大卫·诺伦(David Nolen)认为他不喜欢这种模式，于是他用一种不兼容的叫做 Om Next 的东西取而代之。我们试图逐步迁移到 Om Next，最终得到了一个过于复杂的前端，有两个状态模型和巨大的开销。

我们最终在 React 中重写了它。回想起来，Om 的变革风险和成本都很高，我们为此付出了代价。我们把时间花在了脚下，而不是前方。

没有一家公司因为一个令人惊讶的新奇或深奥的技术选择而获胜。然而，成功的公司不胜枚举，因为它们能够快速灵活地行动，适应变化。技术应该是帮助我们满足客户需求的加速器。充分理解的、经过生产测试的工具更有可能符合这个要求。正如我的同事 Bear 所说，“如果一个工具没有帮助，它就不是工具，而是一件苦差事。放下它。”

## 结论

不可预见的变化是我们许多人现在最关心的问题，而且比以往任何时候都更明显的是，在商业中，没有人能够预测未来。这是一个安全的赌注，通用汽车公司的人没有开始考虑如何利用他们的工厂来制造通风机。

准备好适应变化需要将变化视为你所做一切的驱动力。观察您的市场是如何变化的，并思考它是如何影响您的体系结构的，以便您可以有针对性地逐步提高其适应性。这将有助于你专注于进化，而不会在不需要的领域浪费时间或金钱。

黑天鹅事件是如此不寻常，以至于研究细节可能没有什么价值，但它们提醒我们现实离我们的计划有多远。