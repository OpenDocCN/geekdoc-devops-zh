# 如何减少易出故障的测试

> 原文：<https://circleci.com/blog/reducing-flaky-test-failures/>

测试有助于您在发布软件之前发现错误，使您能够向客户交付高质量的产品。然而，有时测试是不可靠的。

## 什么是片状测试？

易变的测试，也被称为飘忽不定，不能产生准确和一致的结果。由于新编写的代码或外部因素，这些测试可能不可靠。

如果你的测试不可靠，它们不能帮助你找到(并修复)所有的错误，这会对用户体验产生负面影响。在本文中，我将帮助您发现您的测试是否有问题，并向您展示如何修复它们。

## 如何发现古怪的测试

片状测试主要是由于测试数据不足、测试环境范围狭窄和技术复杂造成的。导致测试不可靠的其他一些因素有:

*   异步等待
*   超时设定
*   一天中的时间
*   并发
*   测试订单相关性

本文接下来的部分将描述如何识别这些因素何时导致测试剥落。也有如何防止这些类型的片状剥落的描述。

### 异步等待

开发人员经常根据特定的数据编写测试。如果测试在数据加载之前运行，它们将变得不可靠。这在广泛使用异步 API 的语言中尤其常见，比如 JavaScript、C#和 Go。

例如，考虑一个从外部 API 获取数据的集成测试。如果应用程序代码异步调用外部 API，但没有明确地等待数据准备好，这可能会导致测试失败。有时候，数据会在测试需要的时候准备好。有时候，不会。成功或失败可能取决于运行代码的机器的速度、网络连接的质量以及许多其他因素。

让测试等待可以提高效率和减少剥落。然而，在自动化测试过程中，等待也会导致长时间的系统延迟。重要的是要注意，由于不恰当的异步调用而导致测试失败的代码通常是在被测试的应用程序代码中，而不是在测试本身中。

### 超时设定

另一方面，异步等待的问题是，如果出现问题，它们可能会永远持续下去。设置超时可以解决这个问题，但是超时会引入一个新的问题。例如，**如果从一个 API 调用加载数据有很长的延迟，测试就会失败，因为等待时间超过了超时限制。**这也会导致测试不稳定。

加载数据时可能会发生超时，原因有几个:

*   对负载过重的外部 API 的调用
*   在慢速机器上从硬盘中检索数据
*   文件从计算机上传到服务器

从 API 加载数据、从相对较慢的磁盘(如 EBS)读取数据或等待文件上传可能需要不同的时间，因此有时会发生超时，因为您必须设置某种时间限制。你不能永远等着事情结束。有时会发生超时，而其他时候测试会成功运行而不会超时。

要解决这个问题，模拟对外部系统的调用通常是一个好主意，以确保您的测试是在测试您的代码，而不是第三方 API 的可靠性。不过，请用你最好的判断力。例如，了解您的应用程序集成的服务是否经常缓慢或不可用是很有用的。在这种情况下,“不可靠”的测试为您提供了有价值的信息，您可能不想做任何更改。

### 一天中的时间

有时，代码行为会在一天中发生变化。这意味着**测试的成功可能取决于测试运行的时间**。例如，假设我们正在为一个预约系统编写自动化测试，该系统包括特定时间间隔的预约时间段。如果我们在生产管道上运行这个测试，它会在不同的时间产生不同的结果。时间段的可用性取决于一天中的时间，这增加了测试的片面性。

### 并发

在应用程序代码或测试本身中可能存在数据竞争、死锁或并发问题。当开发人员对不同线程执行的操作顺序做出不正确的假设时，这可能会导致不可靠的测试。

测试执行中的不确定性不一定是一个问题，因为在一些情况下，多个代码行为是正确的。当测试只检查所有可能的有效行为的子集时，结果可能是剥落。

### 测试订单相关性

测试可能会因为之前或之后运行的测试而失败。这是因为许多测试同时使用共享数据，如状态变量、输入和依赖关系。

我们需要完全消除或最小化这些测试之间的依赖性，以提高准确性并减少碎片。只要你的测试依赖于另一个模块，就使用存根和模拟。存根是具有对请求的预定义响应的对象。仿制品(也称为赝品)是模仿工作表现的物体，但不是 100%的产品。模仿和存根会创建孤立运行的测试。

## 如何防止片状测试

以下是您可以使用的策略的快速概述:

*   加载数据时，通过观察超时和延迟来避免异步等待
*   模拟对外部系统的调用以防止超时
*   将测试移到对您的团队来说最理想的时间
*   微调操作顺序以实现最大并发性
*   最小化测试订单依赖性

## 自动化薄片测试检测

回顾你所有的测试，更不用说每一个具体的剥落因素，是一个耗时的过程。自动化脆弱测试检测的最简单的方法是自动化运行您的测试并收集和显示数据的系统。像 CircleCI 这样的持续集成和持续交付(CI/CD)工具可以提供帮助。

### 失败的原因是什么:应用程序还是测试？

测试失败只有两种方式。要么是测试不可靠，要么是应用程序没有按预期工作。有必要了解测试失败是由于剥落还是真正的应用问题。如果是片状测试，我们可以优化测试以减少片状。如果是应用程序故障，您应该向相关的风险承担者报告这个有效的故障。

成功率可以是主分支中唯一的真实来源，因为主分支上不应该有测试失败。它应该有百分之百的成功率。如果成功率低于 100 %,要么是由于应用程序问题导致测试失败，要么是测试不可靠。

### 利用来自改进的洞察力的数据

一旦您有了自动化的测试运行程序，您就可以开始收集数据了。例如，CircleCI 提供了一个带有片状测试检测的 [Test Insights 仪表板](https://circleci.com/blog/introducing-test-insights-with-flaky-test-detection/)，可以帮助您分析和诊断间歇性测试故障和事件。Test Insights 提供了您最近 100 次测试执行的详细概述，并将自动标记非确定性失败的测试以及那些长期运行或最常失败的测试。

CircleCI 还提供了 [webhooks](https://circleci.com/blog/create-customizable-experiences-with-circleci-webhooks/) ，用于集成第三方监控和观察工具，如 Data Dog 和 Sumo Logic。这提供了实时工作绩效监控和具有用户友好界面的高级 CI 分析等优势。这些集成的仪表板提供了早期指标的识别，因此开发人员可以有效地解决影响其应用程序的问题。

### 更快地发现和交流故障模式

仪表板面板包括一个作业分析概览，用于跟踪和显示项目中的作业状态等实时数据，CircleCI [管道](https://circleci.com/blog/what-is-a-ci-cd-pipeline/)的作业结果可视化，以及管道中十大最慢成功作业的可视化。

像 CircleCI 这样的工具可以检测出不稳定的测试，因为**自动化可以让你更频繁地运行测试，从而更容易注意到你可能会忽略的失败模式**。自动化还有助于开发更好的技术来检测不稳定的测试，减少不确定性，修复测试，将测试失败标记为不稳定或不稳定，并防止未来的不稳定测试。

## 包裹

既然您对易变测试的危险、如何检测它们以及如何修复它们有了更多的了解，那么考虑使用自动化工具来帮助您更好地进行测试。我希望我已经说服您尝试使用您的 CI/CD 管道来自动发现不可靠的测试。您可以马上开始，今天就注册您的 [CircleCI 免费试用](https://circleci.com/signup/)。