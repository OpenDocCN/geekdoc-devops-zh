# 排除无法解释的构建失败:神秘的“什么都没有改变”案例

> 原文：<https://circleci.com/blog/troubleshooting-unexplained-build-failures-the-mysterious-case-of-nothing-changed/>

**来自出版商的说明:**您已经找到了我们的一些旧内容，这些内容可能已经过时和/或不正确。尝试在[我们的文档](https://circleci.com/docs/)或[博客](https://circleci.com/blog/)中搜索最新信息。

* * *

在支持的第一线，我们经常收到用户询问，为什么他们的构建在什么都没有改变的情况下突然开始失败了。在回答了近两年的这类问题后，我现在可以充满信心地说，这些案例中的每一个都有所改变。

明确地说，“我的代码中没有任何变化”可能是一个非常有效的陈述。但是“一切都没变”的想法几乎总是错误的。将持续集成引入到您的软件开发工作流中的本质就是测试无论发生什么变化都不会破坏您的应用程序。在本帖中，我们将探讨一些最常见的变化，这些变化是我们在排除意外构建故障时可能没有想到的。

> 变化是唯一不变的。*–未知*

我最近得知，人们一直错误地将这句古老的名言归因于一位名叫赫拉克利特的希腊哲学家。换句话说，既然我们不能确定到底是谁先说了这句话，甚至这句话的出处也在不断变化。)

### CircleCI 构建映像

我们一直在更新我们的构建映像。我们尽最大努力对一系列 canary 项目进行彻底测试，并在我们社区网站的公告部分提前通知我们的用户即将到来的更新。然而，尽管我们尽了最大努力，有时我们所做的改变会破坏你的构建。这个问题没有很好的解决办法，因为我们一直试图在一个“一刀切”的世界里创造一个“一刀切”的形象。好消息是:在我们即将发布的 CircleCI 2.0 平台中，用户将可以完全控制他们的执行环境。我们希望这意味着在未来，我们将永远无法打破你的建设了。

### 取消固定的相关性

依赖性管理是艰难的。每种语言和框架都试图用自己的方式解决依赖管理的问题。这导致了各种工具之间的一些不一致。此外，现代框架具有相当大的依赖链，使得开发人员几乎不可能跟踪它们。这是当“什么都没有改变”时构建失败的最常见原因。

如果你选择的语言使用了`DependencyList.lock`模式，那么你的状态通常很好。如果没有(我正在看你的 pip 和 npm)或者鼓励使用相对版本(比如软件> =1.2)，那么不幸的是，你的依赖将导致你的构建失败只是时间问题。当你今天运行`pip install foo`，一个月后运行`pip install foo`，除非你明确地说`pip install foo==1.2.3`，那么`foo`的版本将会不同。只有当`foo`拥有 10 个其他 Python 模块的依赖图时，这个问题才会变得更加复杂，其中一些模块可能也是您正在安装的 bar 包的依赖项。这被称为依赖地狱，作为依赖地狱的幸存者，我可以告诉你这不是一个好地方。

这里没有简单的解决办法。处理这个问题的一些策略是:清理你的`circle.yml`(和任何脚本)以确保你没有任何悬而未决的非固定依赖。

仔细检查你的依赖:你真的需要它们吗？(也就是说，您在 9 个月前安装的节点模块看起来非常整洁，但是您还没有在您的代码中使用它)。

花点时间定期清理和更新你的依赖关系。

### 第三方服务

如果你的集成测试依赖于第三方服务，请记住这些事情一直在变化。这些变化范围很广，从你没有听说过的重大的、突破性的 API 变化，因为不知何故时事通讯出现在了你的垃圾邮件文件夹中，到那天一些服务的简单的剥落。让您的构建始终可重复的最好方法是减少对第三方的依赖。嘲笑请求和外部系统是一个好策略。如果你不能用嘲讽来完成你的目标，那么你必须在你的测试套件中建立一些容错机制。

### 更改凭据和环境变量

如果 Heroku CLI 告诉您，您的用户不再有权上传新版本的应用程序，那么很可能您的用户不再有权上传新版本的应用程序。

在这个话题上没有什么可说的了。错误消息很少欺骗你。这个问题最大的罪魁祸首是你的团队中有人改变了一些事情，却没有告诉你。

> "忽略这张票，看起来有人改变了我们昨晚的部署方式."

### 在团队中工作可能很难

随着你的产品和公司的成长，跟踪所有的活动部分变得越来越有挑战性。还记得上周你对那份有 120 个新文件的公关做代码审查，还说“LGTM”吗？这是 120 个刚刚改变的东西，可能没有与之相关的测试。现在一个星期过去了，那些虫子都长大了，也不开心了。

这些通常是我们团队最容易解决的问题，也是最让用户沮丧的问题。我唯一的建议是做一个体贴的队友，向人们传达突破性的变化。如果你在一个分布式团队中工作，这一点尤其正确。

找出构建意外失败的原因可能会非常令人沮丧。好消息是 CircleCI 支持团队会在这种情况发生时提供帮助。请记住，下一次你的构建自然地失败，那是因为*某些东西*已经改变了。幸运的是，CircleCI 提供了像 Rollbar 这样的解决方案，它可以[跟踪何时进行部署](https://circleci.com/blog/tracking-errors-after-deployments-with-rollbar-and-circleci/)，并且可以[自动识别哪些代码更改导致了错误](https://circleci.com/blog/automatically-identify-which-code-changes-caused-errors/)。