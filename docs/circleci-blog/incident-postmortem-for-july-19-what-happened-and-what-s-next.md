# 7 月 19 日事件事后分析:发生了什么，下一步是什么

> 原文：<https://circleci.com/blog/incident-postmortem-for-july-19-what-happened-and-what-s-next/>

7 月 19 日，CircleCI 面临站点范围的中断，这使得数千个团队在一天的大部分时间里无法测试和部署构建。这次中断影响了许多开发团队的生产力，并且肯定导致了一些错过的最后期限。我们重视客户对我们的信任，并对由此给他们的工作带来的影响深感抱歉。对于那些感兴趣的人，我们想给出更多关于发生了什么，为什么会发生，以及我们正在做什么的细节。

### 发生了什么事？

世界协调时 2018-07-19 16:46:14，CircleCI 的一个内部证书颁发机构(CA)的根证书意外过期，导致该 CA 颁发的所有证书同时失效。正在讨论的 CA 用于 CircleCI 环境中运行的所有 Mongo 实例(总共 17 台主机)。使用内部 CA 要求将根证书分发给每个客户端，以便建立信任关系。由于影响范围，数百台主机和容器受到影响。为了避免重写每个客户端主机的证书库，我们为所有 Mongo 服务器生成了第三方证书，并重新配置了服务器以使用这些证书。

### 我们是怎么到这里的？

在 2015 年夏天，在 CircleCI 雇佣第一个 SRE 团队成员之前，当我们的第三方 Mongo 托管提供商一直让我们失望时，我们开始构建一套内部管理的 Mongo 服务器，我们可以扩展这些服务器以满足我们的需求，并使用我们认为更适合我们提供的服务的工具进行管理。虽然我们已经把目光放在了离开 Mongo 上，但我们也知道我们可能会在未来很长一段时间内使用它。2015 年 8 月初，在构建最终成为 5 个独立副本集的第一个副本集时，我们创建了一个内部证书颁发机构，开始为我们的副本集颁发证书。该证书的有效期为 10 年，以避免在处理关键基础设施的内部轮换证书时遇到一些挑战。做出这个决定的时候，还没有像今天这样方便地轮换证书的工具。

在 2015 年 9 月下旬，当我们准备开始将流量迁移到我们的新 Mongo 集群时，一名审查人员发现用于签署我们的服务器证书的根证书正在使用 SHA1 作为签名算法。该证书立即被替换为一个新的证书，它使用 SHA512 作为签名算法。其意图是该证书也将有 10 年的有效期。然而，我们最近发现，情况并非如此。虽然我们无法访问机器，因此无法访问创建该证书的原始命令，但很明显，操作员的错误导致生成的根证书的有效期较短。

我们用这个根 CA 生成和签名的所有特定于服务器的证书都有 10 年的有效期，我们检查了这些证书以确保我们不急于替换它们。

### 为了避免这种情况再次发生，我们要改变什么？

避免此类事件发生的大部分工作是我们已经完成的工作。在我们部署 Mongo 基础设施以来的这段时间里，我们的 SRE 团队成员从 0 人增加到了 9 人，我们在运营基础设施方面投入了大量资金。我们现在使用自动化工具来管理我们的内部证书，并使用多个第三方来处理我们的整体 TLS 证书加载。我们还监控随后构建的所有系统的证书到期时间。

不幸的是，基于我们有一个相当大的窗口来处理工具的迁移，我们允许我们的 Mongo 基础设施上的证书管理的迁移被去优先级化。我们目前正在审核我们在整个基础设施中对 TLS 的所有使用，以识别任何没有使用我们工具的最新标准的配置。我们还在寻找旧系统基础设施上的任何其他非标准配置，以使我们的所有系统达到我们当前的监控和维护工具水平。具体到此次事件中的 Mongo 服务器，我们将来自内部 CA 的证书替换为外部提供的有效期为 1 年的证书，现在我们已经清除了该事件，将积极地将它们迁移到我们的公共基础架构。

### 我们还学到了什么？

我们有一个工程团队，非常重视同行代码审查和自动化，以便在错误进入生产之前将其捕获。这是我们如此依赖基础设施而不是代码的原因之一。但是，即使在这些工具还没有很好开发的时候，我们还没有把它们中的一些放在适当的位置上，仍然有可能以手工的方式进行同行评审。当采取有风险的行动时，我们经常这样做。一句简单的“我要用这个命令做这件事”来获得第二双眼睛的“LGTM”总是值得的。