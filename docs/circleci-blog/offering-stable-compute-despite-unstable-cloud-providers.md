# 在不稳定的云提供商上实现稳定的计算| CircleCI

> 原文：<https://circleci.com/blog/offering-stable-compute-despite-unstable-cloud-providers/>

对于 CircleCI 来说，云提供商停机是一个常见且不可避免的问题。对于我们的客户来说，启动失败的最常见原因之一是可用性区域降级，这可能是由多种原因造成的，包括网络错误、操作失败以及区域达到其容量限制。

对于使用我们的机器执行器或远程 Docker 功能的客户，我们使用我们的云提供商为构建中的每个执行器旋转一个全新的虚拟机(VM ),然后在构建完成后将其丢弃。由于这些虚拟机需要几分钟的时间来启动，因此我们维护了一个预启动虚拟机池，以便构建可以在很少甚至没有等待时间的情况下开始。当我们的云提供商全力以赴时，这很方便，但当他们遇到故障，从而影响客户的等待时间时，这就不那么方便了。

尽管我们尽最大努力将区域故障对客户和工程师的影响降至最低，但再多的指标、警报、日志记录和文档也无法完全解决问题。虽然云提供商通常不会认为某个区域宕机违反了他们各自的 SLA，但我们在向客户提供计算时会寻求超越这一责任级别。因此，为了提高我们在面对这些不可避免的问题时的容错能力，我们决定提出一个内部解决方案。

## 挑战

> 现在是上午 11 点 23 分，我已经进入状态，正在追踪一个已经困扰我们两个多小时的 bug。突然，我的电话响了。这是传呼机的责任。"任务等待时间超过资源类型:中等图像:ubuntu-1604:201903-01 "。我叹了口气，点击“确认”，并进一步阅读提醒信息。
> 
> 我打开仪表板，将症状与操作手册进行比对。然后，我评估客户影响——这次停机看起来很严重。我前往#incident Slack 频道向团队汇报最新情况。我努力缓解问题并监控恢复情况。最终，等待时间缩短，事件得以解决。太好了，现在我在做什么？

不幸的是，当你依赖云提供商时，这种类型的中断是不可避免的。这种中断不仅会增加客户的等待时间并占用工程资源进行修复，还会导致我们落后于对虚拟机的需求，客户的构建将在队列中等待更长时间。

在我们解决这个问题的早期尝试中，我们为客户等待时间建立了一个阈值。一旦等待时间超过阈值，就会触发数据狗警报，并呼叫工程师。从那时起，诊断和修复问题的手动过程是有效的，但效率低下。工程师需要查阅操作手册，找出哪个区域降级了，配置更改，然后部署它们。移除不健康区域后，他们还需要手动启动虚拟机，以跟上构建的进度。最后，一旦团队陷入了积压，工程师还必须记住在区域恢复后重新启用它。

尽管我们的系统能够容忍一些故障(比如机器无法启动或者 API 不合作)，但我们收到的大多数警报都需要工程师来诊断问题。尽管我们努力提前触发警报和寻呼，按数据中心和区域隔离故障，甚至跟踪提供商机器的生命周期以帮助我们提前预测停机，但一旦我们知道有问题，我们仍然必须手动将流量从降级区域重新路由。这让客户排队等候，工程师们争先恐后地抢在问题前面。

## 解决方案

我们没有对区域故障和缓慢的构建时间做出反应，而是决定寻找一种方法来主动减轻对客户的影响，即使我们无法控制云提供商区域的健康状况。我们需要一种解决方案，能够自动检测某个区域何时不正常，停止该特定区域中的虚拟机运行，并在该区域恢复正常时自动将其添加回我们的循环中。

我们选择了断路器设计模式作为这个问题的最佳解决方案。在这个模式中，断路器用于控制对外部资源的访问——在本例中是提供者可用性区域。当与提供者区域交互的成功率低于某个阈值时，断路器“打开”,对资源的访问被切断，将流量重新路由到另一个区域。经过一段时间后，允许少量的交互来确定成功率是否已经恢复正常。如果是这样，断路器“闭合”，允许再次访问资源。否则，断路器返回到“打开”状态，并重复测试，直到该区域恢复正常。

通常，断路器在内存中实现。但是，内存模式对我们来说并不可行。在我们的系统中，在进行 API 调用以启动 provider-zone 中的 VM 之后，我们将一条消息放在一个队列中，以便另一个工作器(在不同的进程中运行)可以等待 VM 启动，SSH 进入，并准备运行客户构建。这意味着需要知道哪些区域运行正常的过程不同于需要知道虚拟机是否在这些区域成功启动的过程，这使得内存中的断路器不适合我们的问题。

我们意识到，我们需要一个集中式断路器实现。我们建立了断路器服务，以跟踪区域成功率并管理每个断路器的状态。这使得在我们的虚拟机配置服务集群中的所有节点上汇总提供商区域成功率成为可能。通过将我们的断路器集中到服务中，我们还能够在一个地方手动设置断路器状态，如果需要的话。

## 结论

自动化断路器系统显著缩短了客户的构建时间，为我们的工程师腾出了时间来处理其他重要项目，并通过减少设置预启动虚拟机以应对区域中断的需求，最终节省了我们的资源。让工程团队松了一口气的是，新系统消除了因该问题而产生的页面需求，并将每次事故对区域中断的总体响应时间缩短了约 20 分钟。

自从实施以来，断路器一直工作得非常顺利，以至于当一个区域在我们的 [Windows 发布](https://circleci.com/blog/windows-general-availability-announcement/)的那个星期降级时，我们甚至没有注意到。断路器会根据需要自动重新路由流量，从而减少客户可能会经历的任何额外等待时间，并腾出团队的时间专注于产品发布。断路器不仅为我们的客户提高了性能，而且它还起到了故障保护的作用，让团队更加确信等待时间不会因为降级区域中缺少虚拟机而增加。