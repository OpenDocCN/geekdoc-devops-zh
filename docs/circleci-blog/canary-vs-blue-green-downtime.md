# 金丝雀与蓝绿色部署来减少企业停机时间| CircleCI

> 原文：<https://circleci.com/blog/canary-vs-blue-green-downtime/>

即使在云出现之前，也没有人喜欢部署停机。由于应用程序托管在限制本地用户访问的传统数据中心，许多组织将部署安排在用户不太可能使用应用程序的时间，如午夜。随着基于云的全天候环境在所有时区的广泛采用，一天中的每个小时都可以使用，易于查找的部署窗口不复存在。每个人都希望他们的应用程序对所有潜在用户始终可用。

[https://www.youtube.com/embed/3Wj5yJ5bHKU](https://www.youtube.com/embed/3Wj5yJ5bHKU)

视频

过去，开发人员在部署变更和更新时会使应用程序离线，从而导致停机。现在，[持续集成和持续部署(CI/CD)管道](https://circleci.com/blog/what-is-a-ci-cd-pipeline/)实现了应用构建、测试和部署的自动化。CI/CD 管道尽可能保持环境正常运行，并加快部署过程。部署应用程序或更新环境仍然会导致停机和其他问题。

在本文中，我们将探讨两种可以几乎消除停机时间的常见部署技术:蓝绿色部署配置和金丝雀部署配置。我们还将了解选择其中一个的一些权衡、要求和优势。

## 无停机部署

对于大多数企业，尤其是那些具有现代应用程序架构和已建立的 CI/CD 管道的企业，目标是随时部署应用程序和功能，而不会对最终用户产生明显影响。这需要快速、安全地将更改部署到生产环境中，而不需要:

*   中断可能正在执行关键任务的用户
*   依靠您的系统完成关键任务流程

您的应用和部署架构在减少部署停机时间方面发挥着关键作用。一般来说，您的环境应该满足 canary 和 blue-green 部署方法的以下要求:

*   可以构建、测试和部署到特定环境的部署管道
*   分布在负载平衡器后面的多个应用程序节点或容器
*   无状态的应用程序，允许集群中的任何节点随时为请求提供服务

当您对应用程序进行更改时，它们应该不会破坏您的数据层。这意味着您应该使数据集中的列可选或可为空。不要为了不同的目的而重命名或重用列。在您的数据层中采用这种非破坏性的方法使您能够在出错时回滚更改或恢复特性。

考虑到这些要求，让我们深入了解第一个零停机部署选项:蓝绿色部署。

## 什么是蓝绿部署？

蓝绿色部署是我们正在考虑的两个选项中更常见的一个，它将您的应用程序环境分成两个资源相等的部分，蓝色和绿色。您在环境的一半(蓝色)上为当前应用程序提供服务，使用负载平衡器来引导流量。然后，您可以将新应用程序部署到环境的另一半(绿色)，而不会影响蓝色环境。

**在您测试和部署到绿色环境的同时，使用您的负载平衡器来引导流量，保持您的蓝色环境为生产用户无缝运行。**当您的部署和测试成功时，您可以切换您的负载平衡器以实现绿色环境，而不会对您的用户产生任何影响。

以这种方式设置应用程序环境还有许多其他好处。例如，如果您的应用程序负载很重，绿色环境还可以充当即时热备用，甚至可以作为灾难恢复活动的一部分。

## 什么是金丝雀部署？

金丝雀部署的工作方式与蓝绿色部署类似，但使用的方法略有不同。canary 部署不是在部署完成后等待切换另一个完整的环境，而是先切换一小部分服务器或节点，然后再完成其他部分。

有许多方法可以为 canary 部署配置您的环境。最简单的方法是像往常一样在负载平衡器后面设置您的环境，但是保留一个或两个额外的节点或服务器(取决于应用程序的大小)作为未使用的备用节点。这个备用节点或服务器组是您的 CI/CD 管道的部署目标。一旦您构建、部署和测试了这个节点，您就可以在有限的时间内将它添加回您的负载均衡器，供有限的人员使用。这允许您在对集群中的其他节点重复该过程之前，确保更改成功。

配置 canary 部署的另一个选项是使用一种称为特性切换的开发模式。功能切换(有时称为功能标志)的工作方式是，将您的更改构建并部署到由打开这些更改的配置所控制的应用程序中。您可以从集群中取出一个节点，进行部署，然后再将它添加回去，但不需要通过负载平衡器进行任何测试或控制。然后，当所有节点都更新后，在向所有人推广该特性之前，您可以为许多用户打开该特性。

然而，这种方法的缺点是开发时间和修改应用程序以支持特性切换的成本。根据应用程序的年龄和大小，开发这个特性可能相当复杂或者几乎不可能。

## 蓝绿色部署与淡黄色部署

那么，蓝绿色和金丝雀这两种方法中，哪一种是零宕机的最佳部署方式呢？两者都是有效的策略，并且都需要一个相当相似的架构，但是有不同的特征。

如果您有能力运行两个完整的应用程序托管环境，并且您的应用程序很少以不向后兼容的方式进行更改，**蓝绿色以最少的应用程序更改提供了最次要的好处。**它实现了零停机环境，在发生性能问题或灾难恢复时，您也可以利用这一环境。

但是，如果您可以提供的额外资源有限，或者您的应用程序是模块化和配置驱动的，那么您可以使用 canary 部署选项。当您缺少一个额外的环境来处理其他事务时，您可以最大限度地减少运行和维护环境的开销。Canary deployment 还提供了一种更简单的方法，可以随时或根据任何标准启用和禁用功能。

然而，这两种方法都需要对应用程序和环境的架构进行一些预先规划和思考。

## 包裹

blue-green 和 canary 部署方法都有助于部署您的应用程序，不会给用户带来任何停机或中断。实现这个目标需要在您的环境和应用程序中启用特定的功能，尤其是负载平衡和无状态架构。

如果您的目标是零宕机，那么在更新和更改环境时，部署自动化和一致性也很重要。使用您的 CI/CD 管道来处理应用程序环境的自动化部署、测试和转换非常有帮助。

现在，您已经有了关于金丝雀和蓝绿色部署策略的更多信息，您可以选择最适合您的企业的策略，并且有望以零停机时间部署您的应用程序。您可以马上开始，今天就注册您的 [CircleCI 免费试用](https://circleci.com/signup/)。