# 通过共享库降低微服务开销| CircleCI

> 原文：<https://circleci.com/blog/reducing-microservice-overhead-with-shared-libraries/>

## 单片与微服务的利弊

这是一个常见的故事:产品团队获得了早期的成功，并成长为一个大型的整体代码库。虽然一切都在一个代码库中，但是可以快速添加功能。这部分是因为能够在代码库中的每个特性之间利用共享代码。

当您的团队添加新功能时，开发人员可以利用现有的代码库来满足需求，如日志记录或特殊错误处理。这使得开发人员有更多的时间来专注于编写为最终用户带来直接价值的代码。

随着产品和组织的持续增长，棘手的部分出现了。随着增长，向代码库添加新功能变得很麻烦。很快就有太多的开发人员在同一个代码上工作，而且，有这么多并发的变化，协调发布变得更加困难。面对这个问题，许多组织决定将整体结构分解为微服务。

## 将整体结构分解成微服务

虽然它使更多的开发人员能够相互独立地工作，但是分解会带来新的障碍。一个新问题是服务间网络调用的额外复杂性和不可靠性。

这种复杂性也减缓了开发。每当一个新的服务被添加到架构中时，它就需要解决相同类型的问题。该服务不再仅仅从其他特性中调用以前编写的函数。

现在团队必须决定如何处理这种情况。

应该使用哪些第三方库？什么是正确的界面？应该测试多少？这是每个团队都要承担的成本，他们被迫花费时间来实现跨领域问题的冗余解决方案，而不是解决服务的主要问题。

一个可能的解决方案是跨微服务使用公共的内部共享库。这种方法使团队能够共享常见问题的解决方案，同时保留在需要时使用定制解决方案的自主权。

在 CircleCI，我们像第三方库一样开发和管理这些库(例如，每个版本都有版本，服务声明依赖于它们的首选版本)。

## 共享库的示例和优势

有些情况下，在一个地方解决问题比使用单独、不同的解决方案更有意义。

### 共享日志库

虽然只使用每种语言的标准库很容易让日志工作，但是团队可以从一个公共库受益，该库可以处理常见日志需求的样板文件。这包括诸如转发、旋转、格式化和机密编辑的配置等功能。

### 共享跟踪库

追踪是一个类似的例子。一旦每个服务都导出了跟踪，那么可观察性就有了很大的好处，比如能够观察到单个客户请求中涉及的每个服务。

与日志记录一样，团队受益于开箱即用的跟踪工作，而不是被迫以同样的方式配置第三方库。该库还可以包含特定于您的组织的逻辑。您可能有一些有意义的字段(例如 customer-id、api-version ),但是要求每个服务都遵循相同的方法来标记跟踪。

### 共享依赖冲突管理库

最后，另一种情况是保持对第三方的依赖。这可能包括错误修复、性能改进或安全补丁。

对于每个服务来说，当他们的 JSON 解析库的版本有一个关键的安全更新需要修补时，注意到这一点是相对简单的。但是，对于每个服务来说，知道某个特定版本是否与该服务正在使用的其他库(如日志和跟踪)兼容可能更具挑战性。在一个地方管理这些依赖关系减少了团队保护代码所需的步骤。

在 CircleCI，我们对这个问题的解决方案叫做 clj-parent。实际上，clj-parent 在我们的各种服务中充当了一个共享的、版本化的依赖锁文件。它使我们能够在一个地方解决这些版本冲突，因此团队只需简单地删除它的单一版本，就可以获得正确的依赖版本。

## 共享库的缺点

没有完美的解决方案，共享库也有自己的挑战。

我们的 clj-parent 项目给需要新版本的托管依赖项的团队带来了额外的开销。我们需要更新 clj-parent 中的依赖版本，并在团队将它引入他们的构建之前发布它。如果我们更新 clj-parent 的速度很慢，那么这个团队现在就会被阻止等待它。

共享库也需要更多的前期工作来做好。添加新特性需要在方法上获得不同团队的一致意见。测试和良好的文档对于确保它能被多个团队使用是至关重要的。最后，保持向后兼容性对于防止使用旧版本破坏服务是必要的。

## 实现共享库的技巧

正如 Sam Newman 在[构建微服务](https://www.oreilly.com/library/view/building-microservices/9781491950340/ch04.html#a50-dry)中所描述的，重要的是不要在微服务之间引入不必要的耦合。共享库应该提供横切基础设施，而不是服务领域逻辑或产品功能。

对于 CircleCI 来说，更新瓶颈挑战的解决方案是让共享库有一个专用的所有者。拥有一个专门的团队可以确保库得到良好的维护，并在出现新的 CVE 时及时更新。

更重要的是，拥有一个独立的团队提供了一个重要的检查点，以确保为一个库提出的代码对不止一个服务有益。这些库应该用于巩固而不是收集功能。换句话说，我们正在标准化一个通用的解决方案，而不是把不同团队的解决方案放在一个地方。

让一个团队专门负责构建共享库对您的组织来说可能是不可行的。在这种情况下，重要的是要有一种图书馆心态，对进入共享库中的内容保持谨慎。

## 降低构建和维护成本

单片与微服务的利弊仍在争论之中。在 CircleCI，我们试图用定义明确的领域来提供服务。在这样做的过程中，一组针对日志、跟踪和度量等问题的共享库帮助降低了构建和维护这些新服务的成本。

通过立即注册您的 [CircleCI 免费试用](https://circleci.com/signup/)，您可以立即开始降低成本并提高效率。