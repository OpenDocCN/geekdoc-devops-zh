# 带 CircleCI 的智能 CI/CD:打造我们的 autoscaler - CircleCI

> 原文：<https://circleci.com/blog/intelligent-ci-cd-with-circleci-building-our-autoscaler/>

当 CircleCI 客户想要开始一个新的构建时，预先预热、预先调配的虚拟机已准备就绪，并且所有依赖项都已安装，可以一周 7 天、一天 24 小时提供服务。CircleCI 机器团队的软件工程师卡宴·盖修说:“顾客是看不见的，这是那种(我们的顾客)只希望能工作的东西。”

但是，当需求日复一日、周复一周不断波动时，我们如何管理随时准备就绪的虚拟机群呢？或者，例如，当 Xcode 映像更新时，我们如何快速转移资源，并且我们需要快速重新分配映像版本以匹配使用情况？

在过去的一年里，这些问题的答案发生了变化，在某种程度上改善了客户在 CircleCI 上运行构建的体验，但对于使用该服务的人来说，这可能不会立即被注意到。以前，我们的流程涉及手动调整资源和基础映像的每个组合的比例级别。我们维护了固定数量的机器，但是客户的需求波动很大。当需求激增时，我们的团队开始行动，调整可用机器的数量和类型。当需求下降时(例如在周末)，我们为闲置的虚拟机付费。

唯一比机器闲置更糟糕的是，我们的工程师不得不拼命工作，以跟上不断变化的需求。机器团队的高级 Fullstack 工程师 John Swanson 解释说:“池的大小是固定的，但任务到达的速度是变化的。"任何排队的迹象都会引来呼叫工程师."虽然保持高可用性和低排队时间对我们来说很重要，但我们也意识到我们需要一种方法来减少工程团队的体力劳动，将他们的能力释放出来从事更高价值的工作。我们如何构建一个可以根据客户需求伸缩的系统？

“我们假设这将是一个非常复杂的公式，”盖修继续说道。“我们都离开了，开始研究。(我们的一个同事)马克回来后说，“我们为什么不试试这个简单的公式？”…实际上效果非常好。"

使用经典的排队论，以及从我们的 VM 服务中收集的数据，该团队能够将样本数据插入到电子表格中不同的排队论模型中。我们很想知道不同的模型会产生什么:每个模型需要预启动多少个虚拟机？

事实证明，排队经验法则在预测我们手动配置 VM scaler 时已经拥有的值方面做了令人难以置信的工作。这给了我们信心去尝试增量应用它。从今年 8 月开始，我们就这样做了。

很快，我们看到高峰时间的排队时间从 3 分钟减少到不到一分钟，非高峰时间的空闲机器也减少了。我们慢慢地将我们的系统从手动扩展过渡到自动扩展，高峰等待时间减少了 60%,并且更加接近非高峰时间的等待时间。

同时，引入自动扩展使我们能够将维护平台上每个资源类所需的工作量从 1 小时/月/资源显著减少到零。通过这样做，我们能够将工程师的时间解放出来，专注于其他工作。

客户开始报告更加一致的工作开始时间，无论是一天中的时间还是一周中的时间。但更重要的是，自动化扩展让我们大大扩展了可供客户使用的资源类型目录。

“以前，分配正确数量的机器需要不断更新每一对图像到资源，”机器团队的产品经理 Alexey Klochay 解释说。“随着我们提供的[机器类型和资源类别]数量的增加，团队的负担也在增加。因此，我们投资于团队效率，这为更多样的客户使用情形带来了更多选择。”举个具体的例子，我们新的 autoscaler 允许我们在更短的时间内发布最新的资源类，包括[窗口](https://circleci.com/blog/windows-general-availability-announcement/)。

* * *

*   要了解更多关于我们的自动缩放器的构建，请听听高级员工工程师(也是那个说“让我们试试排队论”的家伙)Marc O'Morain 在 [TheREPL 播客](https://www.therepl.net/episodes/29/)上的发言。

*   关于智能 CI/CD 的更多信息，请了解 CircleCI 的[自动测试分割](https://circleci.com/blog/intelligent-ci-cd-with-circleci-test-splitting/)。