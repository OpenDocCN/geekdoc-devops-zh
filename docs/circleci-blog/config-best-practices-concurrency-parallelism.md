# 配置最佳实践:并发性和并行性| CircleCI

> 原文：<https://circleci.com/blog/config-best-practices-concurrency-parallelism/>

您上次更新 CI/CD 工作流是什么时候？一年前？从来没有？我的朋友们，你们并不孤单。重新配置工作流可能是 DevOps 从业者最艰巨的任务之一。但是有了从 CircleCI 计划中获益的新机会，有一个简单而有效的起点:理解并发和并行。

使用并发性和并行性可以显著缩短构建时间。但是您需要知道它们是什么，以及如何在您的配置文件中找到它们。

## 什么是并发？

并发意味着多个计算任务同时发生。它在计算中无处不在。我们有如此多的事情同时发生:应用程序运行，计算机在网络中通信，甚至用户访问网站。并发是如此普遍，以至于很容易假设我们知道它是如何工作的。虽然定义总是保持不变，但并发的实际应用可能会有细微差别。那么在 CircleCI 中并发意味着什么呢？

> 简单地说，CircleCI 中的并发性是在任何时间点正在执行的任务的数量。例如，CircleCI 的免费计划提供了 30 的并发限制，这意味着您可以同时运行多达 30 个任务。

计算有多少并发任务正在发生比找出有多少作业正在运行或者有多少容器正在被使用要复杂一些。流水线可以有各种各样的曲折来改变并发任务的数量，像[条件逻辑](https://circleci.com/docs/configuration-reference/#logic-statements)或[测试分割](https://circleci.com/docs/parallelism-faster-jobs/)。在这篇文章中，我将重点讨论如何管理并发性以及何时管理并发性很重要。

## 什么是并行？

在 CircleCI 中，如果不谈论并行性，很难写出并发性。这两个概念经常被混淆，但有不同的应用。我们已经知道并发是在工作流中任何给定时间执行任务的数量。我们可以通过改变并行性来影响并发性，这也是一些混乱开始的地方。

> 并行性在特定作业的相同副本之间分割工作。

并行最常用于[分割测试套件](https://circleci.com/blog/a-guide-to-test-splitting/)。作业的所有副本都有相同的指令，但运行时使用不同的变量。并行度在 CircleCI 配置文件中设置，并行作业的数量计入您的并发总数。

## 应用并发和并行

这里有一个使用 CircleCI free 计划的例子，它的并发限制是 30。假设您有 10 个作业，每个作业需要 1 分钟来执行。如果没有并发，此工作流将需要 10 分钟才能完成。有了并发性，这些作业中的每一个都可以同时运行，工作流将在 1 分钟内完成，而不是 10 分钟。如果将并行度设置为 3，您仍然可以同时运行 10 个作业，并且不会超出并发限制。您可以在一分钟内运行 10 个作业的 3 个副本，总共完成 30 个任务。

对于总共 28 个并发任务，您可以轻松地在 7 个作业上运行 4 个副本(并行度为 4)。自由计划允许的最大并行度为 4，但如果你真的需要速度，其他计划有更多的选择。

如果您遇到同时执行的任务总数超过 30 个的情况，一些工作将不得不等待。例如，如果您将 8 个作业的并行度设置为 4，则其中一个作业(及其所有副本)将不得不等待，直到有可用资源。由并行性创建的作业副本总是同时运行，因此即使您仅超出并发限制 2(如本例所示)，一个作业的所有四个副本都会等待另一个作业完成。

## 如何为您的管道增加并行性和并发性

大多数时候，您不需要担心并发性。并发限制由您的 CircleCI 计划设置，并在后台实施。您可能根本不需要管理并发性。大多数情况下，您将通过使用并行性来利用您的并发性。设置并行性很简单:在 config.yml 中设置 parallelism 键的值。任何大于 1 的值都意味着您正在运行并行任务。

### 如何设置并行度

```
 ~/.circleci/config.yml

version: 2
jobs:
  test:
    docker:
      - image: cimg/<language>:<version TAG>
        auth:
          username: mydockerhub-user
          password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
    parallelism: 3 
```

这个例子有一个作业(名为 test)正在 Docker 上运行。将 parallelism 设置为 3 意味着该作业的三个副本(称为任务)将同时在三个独立的 Docker 容器上运行。这些任务之间的唯一区别是环境变量，因此可以在这些任务之间划分工作。这最常用于测试分割，[你可以在我们的文档](https://circleci.com/docs/parallelism-faster-jobs/)中读到更多。

## 结论

作为 DevOps 实践者，我们关心并发性，因为它通过同时运行多个进程来帮助更快地完成工作。了解计划的并发限制以及所有与它相关的任务有助于优化您的构建。

并发可能是一个简单的概念。当至少有一些作业可以同时运行时，它们会更快地完成。并行性有助于您定制并发执行的任务，并且可以在配置文件中轻松设置。并发性和并行性都有助于更快地完成任务，这样您就可以着手处理失败、传递和交付软件的重要事务。

下一步是[继续学习测试拆分，并继续自动化和加速您的工作](https://circleci.com/docs/parallelism-faster-jobs/#using-environment-variables-to-split-tests)。如果您对 CircleCI 配置的专家评估感兴趣，以帮助优化您的工作，您可以通过注册[高级支持计划](https://circleci.com/support/plans/)获得专门支持工程师的定制评估。