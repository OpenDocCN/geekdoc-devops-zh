# 每个运营团队都需要 3 个 Kubernetes 护栏

> 原文：<https://www.fairwinds.com/blog/3-kubernetes-guardrails-every-team-needs>

 在真正的 DevOps 环境中，运营和开发人员共同负责 Kubernetes 环境。运营部门确保核心平台平稳运行，而开发部门负责打包他们的应用程序并将其发送到集群中。

假设运营团队是一个经验丰富的 Kubernetes 工程师团队，那么构建一个安全、高效、可靠的集群并不难。但是一旦您让开发人员与集群进行交互，事情就会变得非常棘手。开发人员通常希望专注于代码和特性，并因此得到回报。基础设施往往是事后才想到的——他们只是想“让它运转起来”

这取决于运营团队将正确的[**Kubernetes****guardrails**](https://www.fairwinds.com/blog/what-are-kubernetes-guardrails)放置到位，以引导他们的开发团队走向最佳实践和策略遵从。这不仅防止了安全漏洞和重大停机等关键问题；它还帮助开发团队更快、更自信地交付，知道他们的更改在进入生产之前会被检查是否有问题。

让我们来看看三个主要的 guardrails Ops 团队应该整合到一起，以帮助开发团队在面向 DevOps 的 Kubernetes 环境中取得成功。

## RBAC

任何 DevOps 驱动的组织应该实现的第一个护栏是基于角色的访问控制，或 RBAC。RBAC 确切地决定了在您的环境中允许每个用户或进程采取什么操作。

至少，您的组织应该针对不同的角色使用三种独特的角色:

*   集群管理员——这是最高级别的权限，可以对集群进行任何更改。这个角色应该只对少数关键人物开放，并且只在“打碎玻璃”的紧急情况下使用。
*   Ops Engineer -该角色应该有广泛的权限来修改集群，而没有什么限制。为了完成他们的工作，操作工程师需要一个在其他人手中可能是危险的访问级别。但是，您可能想要削减权限，比如`create pods/exec`或`get secrets`
*   开发者——这个角色应该有最低限度的权限。它通常是一个只读角色，允许开发人员查看其工作负载的日志和状态。角色也可以绑定到特定的名称空间，这样一个开发人员就不能查看另一个团队的日志。

此外，您应该创建一个“应用程序部署”角色，该角色可以在持续部署流程中使用。这将需要比开发人员角色更多的权限(因为它必须进行修改)，但可以被限制做类似修改`kube-system`名称空间的事情。

RBAC 是实施护栏的良好开端。如果做得好，它可以成功地控制非专家(甚至是疲惫的专家)的一些诚实错误的爆炸半径！)可能会使。但这还不够，开发人员仍然可以自由支配他们的名称空间，并且可以很容易地错误配置他们的工作负载，从而造成安全漏洞、大量资源浪费或非常不可靠的应用程序。

## 政策

运营团队必须设置防护栏，以确保所有应用程序工作负载都得到正确配置。Kubernetes 提供了很多方法来调整应用程序的安全配置文件、资源使用和弹性，缺省值通常是不够的。

例如，默认情况下，每个工作负载都允许[作为根用户](https://www.fairwinds.com/blog/how-to-identify-kubernetes-pods-running-root)运行。在容器化的环境中，这看起来可能是安全的，但是在某些情况下，攻击者能够逃离容器并访问主机。如果容器以根用户身份运行，攻击者就可以以根用户身份访问主机节点，从而造成严重破坏。确保所有应用程序以非 root 用户身份运行是缩小攻击面的一种简单方法。

类似地，Kubernetes 将很乐意允许您部署一个没有内存和 CPU 设置或者没有健康探测的工作负载。但是，如果您想要零停机部署和合理的自动伸缩行为，就必须设置这些选项。

对于面向用户的应用程序，您的组织至少应该实施以下策略:

*   指定内存和 CPU 设置(请求和限制)
*   指定活动和就绪探测器
*   加强安全性:

*   不允许以 root 用户身份运行、以特权身份运行和特权提升
*   不要添加任何额外的 [Linux 功能](https://docs.docker.com/engine/reference/run/#runtime-privilege-and-linux-capabilities)
*   不要设置主机 IPC、主机 PID 或主机网络

您可能还需要一些额外的实施策略，如:

*   具体的标记方案(例如，确保每个工作负载都有一个`costCenterCode`)
*   放弃所有默认的 Linux 功能
*   确保所有工作负载都有横向 Pod 自动扩展和 Pod 中断预算
*   剔除具有已知 CVE 的容器

这些策略应该作为准入控制器来执行。这将扫描对 Kubernetes 集群的所有修改，并拒绝任何违反策略的修改。您可能还想让运营团队在某些情况下有所例外。

## 基础设施代码扫描

有一个准入控制器是一个很好的开始，但是很快你会发现开发团队抱怨这降低了他们的速度。这与我们想要的好的 Kubernetes 护栏正好相反！

问题是，开发人员只有在将他们的更改合并到他们的基础设施即代码(IaC)存储库的主要分支之后，才能从准入控制器*获得反馈。这意味着，如果出现问题，他们将不得不返回，进行更多的更改，然后再试一次。这个循环会很慢，很累。*

相反，作为持续集成(CI)过程的一部分，在准入控制器中实施的相同策略也应该在基础设施即代码上实施。这样，开发人员无论何时发出拉请求，都会得到反馈，在变更合并到主分支之前*。开发人员可以快速修复其分支的任何问题，并自信地合并，因为他们知道如果 CI 管道通过，准入控制器将接受部署。*

幸运的是，许多开源和商业 Kubernetes 策略工具在这方面做得很好。特别是，Fairwinds 开源项目 [Polaris](https://polaris.docs.fairwinds.com/) 能够针对基础设施即代码文件以及准入控制器运行其策略(内置和自定义策略)。一些口味的 [OPA](https://github.com/open-policy-agent/opa) 也能做到这一点。

## Kubernetes 护栏助您安全快速移动

对于任何运营 Kubernetes 的组织来说，合适的护栏都是必不可少的。有了正确的 RBAC、准入策略和 [IaC 扫描](https://www.fairwinds.com/blog/why-infrastructure-as-code-kubernetes),开发团队可以更快地交付，而运营团队可以确保他们的集群保持安全、高效和可靠。

如果您希望在您的组织中实施 Kubernetes guardrails，请查看 [Fairwinds Insights](https://www.fairwinds.com/insights) 。它附带了 100 多种内置策略(外加 OPA 和 Polaris 自定义策略),可以在整个开发生命周期中强制执行，它们可以在 IaC 上运行，在准入控制中运行，或者按计划扫描您的实时环境。策略甚至可以定制，并限定于特定的集群、命名空间、标签等。

> 借助 Fairwinds Insights ，在一个平台中为 [免费获取 Kubernetes 安全性、成本分配和规避、合规性和护栏。](https://www.fairwinds.com/coming-soon)

无论您是使用开源解决方案还是与商业合作伙伴合作，为您的 Kubernetes 环境设置防护栏都将有助于您的开发人员快速、自信地发布产品。

[![Use Fairwinds Insights for Free Security, Cost and Developer Enablement In One](img/7c86296320eb01b215d8e2755e9c5b9d.png)](https://cta-redirect.hubspot.com/cta/redirect/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a)