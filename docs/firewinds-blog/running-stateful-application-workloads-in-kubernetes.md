# 在 Kubernetes 中运行有状态应用程序工作负载

> 原文：<https://www.fairwinds.com/blog/running-stateful-application-workloads-in-kubernetes>

 我们从客户和潜在客户那里得到的最常见的问题之一是，“你会在 Kubernetes 上运行我们的数据库吗？”通常我们的答案是“不，你可能也不应该”，但在某些情况下，如果你愿意承担额外的工作和复杂性，运行数据库等有状态应用程序工作负载可能是正确的选择*。*

## 你从哪里开始？

有很多原因(有些好，有些不好)让你希望在 Kubernetes 上运行数据库。除非这是一个真正的绿地项目，否则您可能已经在云提供商或数据中心愉快地运行了一个或多个数据库实例。

让我们检查一下你可能有的一些可能的原因，更重要的是，Kubernetes 是可能有帮助还是有伤害。

也许你有一些 Terraform 或其他配置管理代码，允许你配置你的 MySQL 副本或你的 Elasticsearch 集群，但并不十分满意。或者您对它很满意，但是您希望集中在 Kubernetes 基础设施部署工作流上，这使得运行 helm install mongodb 变得非常诱人。也许你读过一篇文章，作者在 Kubernetes 上不到 10 分钟就创建了一个 Wordpress 实例。您可能一直在尝试手动管理 PostgreSQL 实例，但它并不可靠，而且您听说 Kubernetes 有助于提高应用程序的可靠性！也许您希望尽可能多地重用您的应用程序部署自动化，并且希望以与您的应用程序相同的方式部署您的 Kafka 实例。

所有这些场景有什么共同点？在 Kubernetes 集群上运行数据库与在 metal 或 VMs 上运行相同的数据库相比，工作量几乎相同或更少。抱歉，事实并非如此。复杂性是附加的。你仍然需要理解底层的数据库配置，如何优化它*以及*如何在 Kubernetes 上运行它。 ***生产数据商店可不好办。Kubernetes 可能会很棘手*，使用 Kubernetes 的数据持久性可能会非常棘手。**

## 考虑云中 Kubernetes 中的持久数据:

自 PetSets 时代以来，Kubernetes 中的 StatefulSets 已经走过了漫长的道路，但是旧名称表明了 Kubernetes 早期版本管理状态的意图。它把[【牛](http://cloudscaling.com/blog/cloud-computing/the-history-of-pets-vs-cattle/) [不是宠物】](http://cloudscaling.com/blog/cloud-computing/the-history-of-pets-vs-cattle/)的想法精确到了豆荚级。如果丢失一个实例(或者本例中的 pod ),不管它恢复得多快，对您来说都是一个问题，那么在 Kubernetes 上管理它将是一个挑战。当它由于某种原因没有自动返回时，它会加倍。

当 PersistentVolume EBS 卷因为无法重新连接到集群中的某个节点(以及许多其他不幸事件)而被孤立时，Fairwinds 已经有了相当多的午夜页面。值得庆幸的是，Kubernetes 核心已经取得了很大进步，像 [Rook](https://rook.io/) 和 [Portworx](https://portworx.com/) 这样的新解决方案已经大大改善了 Kubernetes 的状态(只要你知道如何正确运行它们)。也就是说，在选择一个可以在 Kubernetes 上运行并保持健康的数据库时，有几件事你应该考虑。

***[Kubernetes](https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/)擅长什么？***

*   服务发现和负载平衡
*   存储编排
*   自动化推出和回滚
*   箱型包装
*   自愈
*   机密和配置管理

这描绘了一个负载平衡连接的平台，可以在负载下水平扩展，自动在负载平衡器中发现新的工作负载实例，并替换失败的实例。对于无状态工作负载来说，这是编排的圣杯，但对于 MySQL 等传统数据库技术来说，这有点麻烦。看这张图，在 Kubernetes 上运行的最好的数据库类型是:

*   分布式的并且能够有多个副本，并且在丢失一些副本时仍然起作用，
*   短暂的，像缓存或开发环境。

***不用担心，我正在使用<* 插入分片多对多复制数据存储 *>！***

太好了，您正在 Kubernetes 上找到一个合理的数据库解决方案！假设:

*   您已经完成了所有的设置和调整，使其能够满足您的用例
*   您有一个可重复的部署方法。
*   社区掌舵图适合你，或者你有自己的专业知识来写。

你剩下要做的就是让它在 Kubernetes 上运行良好:考虑限制/资源、网络政策、Pod 中断预算、自动扩展，并考虑在 Kubernetes 上运行任何应用程序的所有其他复杂因素

你需要多区吗？多地区？多云？如果您需要多区域或多云，很有可能您需要添加一个服务网格，如 [linkerd](https://linkerd.io/) 或 [Istio](https://istio.io/) 或添加到列表中，并且您需要解决延迟问题。您的 PodDisruptionBudgets 配置好了吗？在升级和停机期间，您能承受多少副本丢失？您是否正确配置了亲缘关系，以确保每个副本都位于不同的节点上？在 AWS 上，您的持久卷是否跨区域分布，然后当在没有持久卷的区域中调度实例时会发生什么？ ***生产数据商店可不好办。Kubernetes 可能会很棘手，而 Kubernetes 的数据持久性可能会格外棘手***

***我的数据库不能牛怎么办？***

它是短暂的吗？如果不是这样，你*仍然可以在 Kubernetes 上用一个副本在 StatefulSet 中运行 MySQL，就像你在大多数例子中看到的简单情况和你在设置 Wordpress 之类的东西时发现的情况一样，但是这样做你会削弱 Kubernetes 提供比运行“老学校”方式更高级别的服务的能力。如果没有负载平衡的副本，每当工作负载在节点之间移动时，您都会遇到服务中断。*

如果它是短暂的，非生产性的，或者任何其他你可以在一段时间内不拥有它的情况，摇滚吧。

## 你要去哪里？

在 Fairwinds，我与一些组织进行了几次对话，他们希望摆脱数据专家，让他们的平台团队在 Kubernetes 上运行他们的数据存储，认为这将消除管理数据库的复杂性。现在你应该看到，在 Kubernetes 上运行你的数据库并没有消除复杂性，它 ***增加了*** 的复杂性。复杂性*可以*带来更高的服务质量，但这肯定不是灵丹妙药，而且做错的方法比做对的方法多。

***好吧，那你推荐什么？***

*   您应该以适合您的方式和位置运行您的生产数据库。如果您和您的团队愿意投入大量精力来充分理解这样做的含义和要求，那么在 Kubernetes 上运行它会是一个很好的选择。 ***生产数据存储可能有些棘手。Kubernetes 可能会很棘手，而 Kubernetes 的数据持久性可能会特别棘手。***
*   如果您选择这样做，我强烈建议*不要*在上运行与其他高可伸缩性工作负载混合在一起的有状态应用程序；使用单独的节点池或群集。针对快速扩展而优化的集群/节点池，在装载和卸载云卷以及移动副本时，您的持久状态更有可能出现问题。 ***生产数据商店可不好办。Kubernetes 可能会很棘手，而 Kubernetes 的数据持久性可能会特别棘手。***
*   不要解雇你的数据库管理员！Kubernetes 上的数据库仍然需要数据库专家。这也需要 Kubernetes 的专家。 ***生产数据存储可能有些棘手。Kubernetes 可能会很棘手，而 Kubernetes 的数据持久性可能会特别棘手。***
*   短暂的缓存和开发环境是可以的。如果您丢失了一个 pod，重新装载卷或重新填充缓存需要大约 90 秒的时间，这种可能性很大。 ***这不是生产数据存储。***

您的里程可能会有所不同。需要进一步帮助吗？

[![Set up a call](img/53e8d84f66d88821bd9b2d3077c5a58e.png)](https://cta-redirect.hubspot.com/cta/redirect/2184645/947c4df4-0adc-4995-b455-8a656bbc764a)