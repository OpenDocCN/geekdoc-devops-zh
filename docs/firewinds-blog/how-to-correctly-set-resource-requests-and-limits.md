# Kubernetes 最佳实践:如何(正确地)设置资源请求和限制

> 原文：<https://www.fairwinds.com/blog/how-to-correctly-set-resource-requests-and-limits>

 管理 Kubernetes 时，我最大的烦恼之一就是工作负载没有资源请求和限制。对此我非常沮丧，于是我创建了一个开源项目 Goldilocks，让设置初始资源请求和限制的过程变得更加容易。在这篇博客中，我将讨论 Kubernetes 正确设置资源请求和限制的最佳实践。

* * *

Kubernetes 是一个动态系统，可以自动适应您的工作负载的资源利用率。Kubernetes 有两个级别的缩放。每个单独的 Kubernetes 部署都可以使用水平 Pod 自动缩放器(HPA)进行自动缩放，而整个集群则使用集群自动缩放器进行缩放。HPA 监视部署中各个单元的目标指标(通常是 CPU 或内存使用情况)，并根据需要添加或删除单元，以使该指标接近指定的目标。同时，Cluster Autoscaler 处理集群本身的扩展。它会监视无法调度的单元，并向集群添加或删除节点以容纳这些单元。

Kubernetes 支持这两种扩展操作的一个关键特性是能够为您的工作负载设置特定的资源请求和限制。通过对每个 pod 使用多少 CPU 和内存设置合理的限制和请求，您可以最大限度地提高基础架构的利用率，同时确保平稳的应用程序性能。为了最大化 Kubernetes 集群的有效利用率，正确设置资源限制和请求是非常重要的。对应用程序设置太低的限制会导致问题。例如，如果你的内存限制太低，Kubernetes 一定会因为你违反了它的限制而杀死你的应用程序。同时，如果你把你的限制设置得太高，你会因为过度分配而浪费资源，这意味着你最终会有更高的账单。

虽然 [Kubernetes 最佳实践](https://www.fairwinds.com/kubernetes-best-practices-comprehensive-white-paper) 规定您应该始终为您的工作负载设置资源限制和请求，但要知道每个应用程序使用什么值并不总是那么容易。结果，一些团队根本没有设置要求或限制，而另一些团队在初始测试时将它们设置得太高，然后永远不会正确。确保扩展操作正常工作的关键是调整每个工作负载的资源限制和请求，以便工作负载高效运行。

设置资源限制和请求是在 Kubernetes 集群上尽可能高效可靠地运行应用程序的关键。

## 如何设置 Kubernetes 资源

Fairwinds 的开源项目 [Goldilocks](https://www.fairwinds.com/goldilocks) 帮助团队将资源分配到他们的 Kubernetes 部署中，并正确地校准这些资源。Goldilocks 是一个 Kubernetes 控制器，它收集关于正在运行的 pod 的数据，并就如何设置资源请求和限制提供建议。它可以帮助组织了解资源使用、资源成本和效率方面的最佳实践。 [金凤花](https://goldilocks.docs.fairwinds.com/) 采用了 VPA 的 Kubernetes 垂直吊舱自动缩放器。它会考虑工作负载的历史内存和 CPU 使用情况，以及 pod 的当前资源使用情况，以便建议如何设置资源请求和限制。(虽然 VPA 实际上可以为您设置限制，但通常最好仅使用 VPA 引擎来提供建议。)本质上，该工具为名称空间中的每个部署创建一个 VPA，然后查询该 VPA 以获取信息。

要查看这些建议，您必须使用 kubectl 来查询每个 VPA 对象，这对于大中型部署来说很快就会变得繁琐。这就是仪表板的用武之地。一旦你的 VPA 到位，建议将出现在金发女孩仪表板。

该控制面板根据您希望部署的服务质量(QoS)等级提供两种类型的建议:

1.  **保证**，这意味着应用程序将被授予比其他工作负载更高的优先级，以保证可用资源。在这个类中，您将您的资源请求和限制设置为完全相同的值，这保证了容器所请求的资源在它被调度时是可用的。这个 QoS 等级通常非常适合最稳定的 Kubernetes 集群。

2.  **Burstable** ，这意味着应用程序将获得最低水平的资源，但如果可用，将获得更多资源。本质上，您的资源请求低于您的限制。调度程序将使用该请求将 pod 放在一个节点上，但是随后 pod 可以使用更多的资源，直到它被终止或限制为止。当资源不足时，在决定删除哪些工作负载时，此 QoS 类别被授予较低的优先级。

仪表板提供了保证和突发 QoS 类别的建议。在保证类中，我们建议将您的请求和限制设置为 VPA“目标”字段。

*注意:第三个 QoS 类别 bestfortion 表示不设置任何请求或限制，并且只有当所有其他请求都得到满足时，才会为应用程序分配资源。不建议使用 BestEffort。*

## 为集群专门化实例组

如果您对优化工作负载运行的实例感兴趣，可以使用不同的实例组类型和节点标签将工作负载导向特定的实例类型。

不同的业务系统通常有不同规模的资源需求，以及专门的硬件需求(如 GPU)。Kubernetes 中节点标签的概念允许您将标签放在所有不同的节点上。同时，可以将 pod 配置为使用特定的“节点选择器”来匹配特定的节点标签，这些标签决定了可以将 pod 调度到哪些节点上。通过利用带有适当标签的不同实例类型的实例组，您可以将您选择的云提供商提供的底层硬件与 Kubernetes 中的工作负载混合搭配。

如果您有不同规模、不同需求的工作负载，那么将这些工作负载放在不同的实例类型上，并使用标签将您的工作负载引导到这些不同的实例类型上，这在战略上和经济上都是有意义的。

Spot 实例与这一想法密切相关。大多数组织都熟悉按需或在固定期限内按保留条款支付实例费用。但是，如果您有可能被中断的工作负载，您可能希望考虑使用 spot 实例。这些实例类型允许您以显著的折扣利用云提供商的剩余容量—当对常规按需实例的需求增加时，所有这些都有实例被终止的风险。

如果您的一些业务工作负载可以承受随机实例终止的风险，那么您可以使用相同的节点标记概念来专门将这些工作负载调度到这些类型的实例组上，从而节省大量成本。

## 如何启用 Kubernetes 资源推荐

Goldilocks 是 Fairwinds Insights 部署来提供工作负载效率和性能优化的工具之一。借助 Fairwinds Insights，Goldilocks 可以跨多个集群部署，因此团队可以在单一控制台中获得信息。Fairwinds Insights 为 Goldilocks 增加了数据和建议，包括潜在的成本节约。出现的控制面板包括名称空间和部署的列表，以及平均总成本和成本建议。

> Fairwinds Insights 可供免费使用。你可以在 这里 [报名。](https://www.fairwinds.com/coming-soon)

许多组织将其 CPU 和内存请求和限制设置得太高，因此当他们应用 Fairwinds Insights 的建议时，他们能够在更少的 Kubernetes 工作节点上放置更多的 pod。启用集群自动缩放后，任何多余的节点在未使用时都会被删除，从而节省时间和金钱。

使用像 Fairwinds Insights 这样的软件或像 Goldilocks 这样的开源工具，开发人员可以通过自动化推荐过程来消除猜测。反过来，它为您打开了提高集群效率和减少云支出的大门。

[![Use Fairwinds Insights for Free Security, Cost and Developer Enablement In One](img/7c86296320eb01b215d8e2755e9c5b9d.png)](https://cta-redirect.hubspot.com/cta/redirect/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a)