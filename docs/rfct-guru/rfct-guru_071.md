# 用状态/策略替换类型代码

> 原文：[`refactoringguru.cn/replace-type-code-with-state-strategy`](https://refactoringguru.cn/replace-type-code-with-state-strategy)
> 
> **什么是类型代码？** 类型代码是指，当你不是使用单独的数据类型，而是有一组数字或字符串形成某个实体的允许值列表时。通常，这些特定的数字和字符串通过常量赋予可理解的名称，这就是为什么这种类型代码如此常见的原因。

### 问题

你有一个影响行为的编码类型，但你无法使用子类来消除它。

### 解决方案

用状态对象替换类型代码。如果有必要用类型代码替换字段值，可以“插入”另一个状态对象。

在此之前！用状态策略替换类型代码 - 之前之后！用状态策略替换类型代码 - 之后

### 为什么要重构

你有类型代码，它影响类的行为，因此我们不能使用用类替换类型代码。

类型代码影响类的行为，但由于现有的类层次结构或其他原因，我们无法为编码类型创建子类。这意味着我们不能应用用子类替换类型代码。

### 好处

+   这种重构技术是解决当具有编码类型的字段在对象生命周期中改变其值的情况的一种方法。在这种情况下，通过替换原始类所引用的状态对象来替换值。

+   如果需要添加一个编码类型的新值，你只需添加一个新的状态子类，而无需更改现有代码（参见*开放/封闭原则*）。

### 缺点

+   如果你有一个简单的类型代码案例，但仍然使用这种重构技术，你将会有许多多余（且不需要）的类。

### 好消息

这种重构技术的实现可以使用两种设计模式之一：**状态**或**策略**。无论选择哪种模式，实施方式都是一样的。那么在特定情况下你应该选择哪种模式呢？

如果你试图拆分控制算法选择的条件，请使用策略。

但如果编码类型的每个值不仅负责选择算法，还负责类的整体状态、字段值和许多其他操作，状态更适合这个工作。

### 如何重构

1.  使用自我封装字段为包含类型代码的字段创建一个 getter。

1.  创建一个新类，并赋予它一个适合类型代码目的的可理解名称。这个类将扮演*状态*（或*策略*）的角色。在其中，创建一个抽象的编码字段 getter。

1.  为编码类型的每个值创建状态类的子类。在每个子类中，重定义编码字段的 getter，使其返回对应的编码类型值。

1.  在抽象状态类中，创建一个接受编码类型值作为参数的静态工厂方法。根据该参数，工厂方法将创建各种状态的对象。为此，在其代码中创建一个大的条件；这将是重构完成时的唯一条件。

1.  在原始类中，将编码字段的类型更改为状态类。在字段的 setter 中，调用工厂状态方法以获取新的状态对象。

1.  现在你可以开始将字段和方法从超类移动到相应的状态子类中（使用 向下推送字段 和 向下推送方法）。

1.  当所有可移动的对象都已被移动时，使用 替换条件语句为多态 来彻底摆脱使用类型代码的条件语句。

</images/refactoring/banners/tired-of-reading-banner-1x.mp4?id=7fa8f9682afda143c2a491c6ab1c1e56>

</images/refactoring/banners/tired-of-reading-banner.png?id=1721d160ff9c84cbf8912f5d282e2bb4>

你的浏览器不支持 HTML 视频。

### 厌倦阅读了吗？

不奇怪，阅读我们这里的所有文本需要 7 小时。

尝试我们关于重构的互动课程。它提供了一种不那么乏味的学习新知识的方法。

*让我们看看…*
