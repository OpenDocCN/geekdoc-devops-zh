# 用子类替换类型代码

> 原文：[`refactoringguru.cn/replace-type-code-with-subclasses`](https://refactoringguru.cn/replace-type-code-with-subclasses)
> 
> **什么是类型代码？** 类型代码是指，当你有一组数字或字符串，而不是单独的数据类型时，这些数字或字符串形成某个实体的可允许值列表。通常，这些具体的数字和字符串通过常量被赋予可理解的名称，这也是为何这种类型代码如此常见的原因。

### 问题

你有一个编码类型，它直接影响程序行为（该字段的值触发条件语句中的各种代码）。

### 解决方案

为编码类型的每个值创建子类。然后将原类中的相关行为提取到这些子类中。用多态性替换控制流代码。

之前！用子类替换类型代码 - 之前之后！用子类替换类型代码 - 之后

### 为什么要重构

这种重构技术是对用类替换类型代码的一种更复杂的变体。

与第一个重构方法一样，你有一组简单值，这些值构成字段的所有允许值。虽然这些值通常被指定为常量，并具有可理解的名称，但它们的使用会使你的代码非常容易出错，因为它们在本质上仍然是原始值。例如，你有一个方法接受这些值中的一个作为参数。在某个时刻，方法收到的字符串为小写形式（`"admin"`），而不是常量`USER_TYPE_ADMIN`对应的值`"ADMIN"`，这将导致执行与作者（你）原本意图不同的操作。

在这里，我们处理的控制流代码包括条件语句`if`、`switch`和`?:`。换句话说，具有编码值的字段（例如`$user->type === self::USER_TYPE_ADMIN`）在这些运算符的条件中被使用。如果在这里使用用类替换类型代码，所有这些控制流结构最好移动到一个负责数据类型的类中。最终，这当然会创建一个非常类似于原来的类型类，但同样存在原有的问题。

### 好处

+   删除控制流代码。将原类中笨重的`switch`代码移动到适当的子类中。这提高了对*单一职责原则*的遵循，并使程序整体上更具可读性。

+   如果需要为编码类型添加一个新值，你只需添加一个新的子类，而无需触及现有代码（参见*开闭原则*）。

+   通过用类替换类型代码，我们为编程语言层面的方法和字段提供了类型提示。这在使用简单的数字或字符串值构成的编码类型时是无法实现的。

### 何时不使用

+   如果你已经有了类层次结构，这种技术就不适用。在面向对象编程中，你无法通过继承创建双重层次结构。不过，你可以通过组合而非继承来替换类型代码。为此，请使用 用状态/策略替换类型代码。

+   如果类型代码的值在对象创建后可以更改，避免使用此技术。我们必须以某种方式在运行时替换对象本身的类，这是不可能的。不过，在这种情况下，替代方案也是 用状态/策略替换类型代码。

### 如何重构

1.  使用 自封装字段 为包含类型代码的字段创建一个 getter。

1.  使超类构造函数为私有。创建一个与超类构造函数具有相同参数的静态工厂方法。它必须包含一个参数，用于接收编码类型的起始值。根据这个参数，工厂方法将创建不同子类的对象。为此，在其代码中必须创建一个大型条件判断，但至少在确实必要时它是唯一的；否则，子类和多态性将会起作用。

1.  为编码类型的每个值创建一个唯一的子类。在其中，重定义编码类型的 getter，使其返回对应的编码类型的值。

1.  从超类中删除带有类型代码的字段。使其 getter 为抽象。

1.  一旦你有了子类，就可以开始将字段和方法从超类移动到相应的子类中（借助 向下推送字段 和 向下推送方法）。

1.  当所有可能的内容都已移动后，使用 用多态性替换条件 来彻底摆脱一次性使用类型代码的条件。

</images/refactoring/banners/tired-of-reading-banner-1x.mp4?id=7fa8f9682afda143c2a491c6ab1c1e56>

</images/refactoring/banners/tired-of-reading-banner.png?id=1721d160ff9c84cbf8912f5d282e2bb4>

你的浏览器不支持 HTML 视频。

### 厌倦阅读了吗？

难怪，阅读我们这里所有的文本需要 7 小时。

尝试我们的交互式重构课程。这提供了一种不那么乏味的学习新知识的方法。

*让我们看看…*
